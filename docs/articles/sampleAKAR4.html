<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Uncertainty Quantification on AKAR4 (deterministic model) • uqsa</title>
<script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Uncertainty Quantification on AKAR4 (deterministic model)">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="file:///usr/share/javascript/mathjax/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
    <a class="dropdown-item" href="../articles/installExplanations.html">Explanation for System Prerequisites</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing Models</a>
    <a class="dropdown-item" href="../articles/data.html">Importing Data</a>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/UQ.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/GSA.html">Global Sensitivity Analysis</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/more_details.html">More details...</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAR4</h6>
    <a class="dropdown-item" href="../articles/simAKAR4.html">Simulate deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/simAKAR4stochastic.html">Simulate stochastic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4.html">UQ on deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4stochastic.html">UQ on stochasic AKAR4</a>
    <a class="dropdown-item" href="../articles/GSA_AKAR4.html">GSA on AKAR4</a>
    <a class="dropdown-item" href="../articles/uqsaAKAR4.html">UQ and SA on AKAR4</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAP79</h6>
    <a class="dropdown-item" href="../articles/sampleAKAP79.html">UQ on deterministic AKAP79</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>CaMKII</h6>
    <a class="dropdown-item" href="../articles/smmala.html">Calibrate CaMKII with SMMALA</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Extra</h6>
    <a class="dropdown-item" href="../articles/extraExamples.html">More examples...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Uncertainty Quantification on AKAR4 (deterministic model)</h1>
            
      
      
      <div class="d-none name"><code>sampleAKAR4.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgsl</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="load-model-and-data">Load Model and Data<a class="anchor" aria-label="anchor" href="#load-model-and-data"></a>
</h2>
<p>The first step is to locate and load the SBtab model files. In this
example we use the SBtab files from an already existing example
(“AKAR4”). (In the article <a href="user_model.html">“Build and simulate
your own Model</a> you can read about how the set up your own SBtab
model. You can list the files in a directory with the <code><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir()</a></code>
command.)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span>  <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4"</span><span class="op">)</span> </span>
<span><span class="va">sb</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#&gt; [tsv] file[1] «AKAR4_100nM.tsv» belongs to Document «AKAR4»</span></span>
<span><span class="co">#&gt;  I'll take this as the Model Name.</span></span>
<span><span class="co">#&gt; AKAR4_100nM.tsv  AKAR4_25nM.tsv  AKAR4_400nM.tsv  AKAR4_Compound.tsv  AKAR4_Experiments.tsv  AKAR4_Output.tsv  AKAR4_Parameter.tsv  AKAR4_Reaction.tsv</span></span></code></pre></div>
<p>From the <code>sb</code> variable (list of data frames with the file
contents) we can create an ordinary differential equation, this will
print lots of text about how it interprets the contents (printouts are
omitted here):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span>  <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_to_vfgen.html" class="external-link">sbtab_to_vfgen</a></span><span class="op">(</span><span class="va">sb</span><span class="op">)</span></span></code></pre></div>
<p>We also load the experimental data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">sb</span>,<span class="va">m</span><span class="op">$</span><span class="va">conservationLaws</span><span class="op">)</span></span></code></pre></div>
<p>We have loaded these constructs:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AKAR4_100nM" "AKAR4_25nM"  "AKAR4_400nM" "Compound"    "Experiments"</span></span>
<span><span class="co">#&gt; [6] "Output"      "Parameter"   "Reaction"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AKAR4_400nM" "AKAR4_100nM" "AKAR4_25nM"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "par"              "exp"              "var"              "vf"              </span></span>
<span><span class="co">#&gt; [5] "func"             "conservationLaws"</span></span></code></pre></div>
<div class="section level3">
<h3 id="generate-c-ode-code-for-model-simulation">Generate C ODE-code for model simulation<a class="anchor" aria-label="anchor" href="#generate-c-ode-code-for-model-simulation"></a>
</h3>
<p>We next take <code>m</code> and generate c code from it, then write
this code into a file (<code>AKAR4_gvf.c</code>):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/generateCode.html">generateCode</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">C</span>,sep<span class="op">=</span><span class="st">"\n"</span>,file<span class="op">=</span><span class="st">"./AKAR4_gvf.c"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>ex</code> variable holds the experimental data and
instructions about how they correspond to model simulations
(<code>ex</code> is a list).</p>
<p>Next, we check that the c sources exist in the specified location,
that the model compiles on the current system, with the default c
compiler (called by <code>checkModel</code>) and a shared library can be
built:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAR4"</span>,modelFile<span class="op">=</span><span class="st">"./AKAR4_gvf.c"</span><span class="op">)</span></span>
<span><span class="co">#&gt; building a shared library from c source, and using GSL odeiv2 as backend (pkg-config is used here).</span></span>
<span><span class="co">#&gt; cc -shared -fPIC `pkg-config --cflags gsl` -o './AKAR4.so' './AKAR4_gvf.c' `pkg-config --libs gsl`</span></span></code></pre></div>
<p>The function <code>checkModel</code> also appends the location of the
shared library as a comment to its return value.</p>
<p>For a test simulation we create the function <code>s</code> which
will remember the experiments to simulate and the model to simulate them
with. The function/closure <code>s</code> maps parameter vectors to
model solutions (trajectories):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simcf.html">simcf</a></span><span class="op">(</span><span class="va">ex</span>,<span class="va">modelName</span>,parMap<span class="op">=</span><span class="va">log10ParMap</span><span class="op">)</span> <span class="co"># or simulator.c</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">sb</span><span class="op">$</span><span class="va">Parameter</span><span class="op">[[</span><span class="st">"!DefaultValue"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sb</span><span class="op">$</span><span class="va">Parameter</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">s</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="co"># here the simulation happens</span></span></code></pre></div>
<p>We can plot the simulated output together with the experimental data
and experimental error:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ylab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputValues</span><span class="op">)</span></span>
<span><span class="va">d_</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputValues</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">e_</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">errorValues</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">t_</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span></span>
<span><span class="va">f_</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">t_</span>,<span class="va">d_</span>,type<span class="op">=</span><span class="st">"p"</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,xlab<span class="op">=</span><span class="st">"time"</span>,ylab<span class="op">=</span><span class="va">ylab</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html" class="external-link">arrows</a></span><span class="op">(</span><span class="va">t_</span>,<span class="va">d_</span>,<span class="va">t_</span>,<span class="va">d_</span><span class="op">+</span><span class="va">e_</span>,angle<span class="op">=</span><span class="fl">90</span>,length<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html" class="external-link">arrows</a></span><span class="op">(</span><span class="va">t_</span>,<span class="va">d_</span>,<span class="va">t_</span>,<span class="va">d_</span><span class="op">-</span><span class="va">e_</span>,angle<span class="op">=</span><span class="fl">90</span>,length<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">t_</span>,<span class="va">f_</span>,lw<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampleAKAR4_files/figure-html/plot-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="take-a-parameter-sample-for-this-model">Take a parameter Sample for this Model<a class="anchor" aria-label="anchor" href="#take-a-parameter-sample-for-this-model"></a>
</h3>
<p>We use just one core as this is a tiny model. No MPI, no parallel
tempering. First we construct the prior:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dNormalPrior.html">dNormalPrior</a></span><span class="op">(</span><span class="va">p</span>,<span class="va">sd</span><span class="op">)</span></span>
<span><span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rNormalPrior.html">rNormalPrior</a></span><span class="op">(</span><span class="va">p</span>,<span class="va">sd</span><span class="op">)</span></span></code></pre></div>
<p>Next, we set up the loglikelihood function and the function
<code>mcmcUpdate</code> which will automatically determine that the
Metropolis Hastings Algorithm should be used with these inputs. Finally
we construct the function ‘MH_MCMC’ (below), which actually performs the
MCMC run, this takes the inital values, number of steps and the stepsize
as arguments.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">llf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logLikelihoodFunc.html">logLikelihoodFunc</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="co">#&gt; experiments contain 675 non-missing values</span></span>
<span><span class="va">metropolis_hastings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcUpdate.html">mcmcUpdate</a></span><span class="op">(</span><span class="va">s</span>,<span class="va">ex</span>,logLikelihood<span class="op">=</span><span class="va">llf</span>,dprior<span class="op">=</span><span class="va">dprior</span><span class="op">)</span></span>
<span><span class="va">MH_MCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc.html">mcmc</a></span><span class="op">(</span><span class="va">metropolis_hastings</span><span class="op">)</span></span></code></pre></div>
<p>Finally, to obtain a sample of parameters:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcInit.html">mcmcInit</a></span><span class="op">(</span></span>
<span>    <span class="fl">1.0</span>,</span>
<span>    parMCMC<span class="op">=</span><span class="va">p</span>,</span>
<span>    simulate<span class="op">=</span><span class="va">s</span>,</span>
<span>    logLikelihood<span class="op">=</span><span class="va">llf</span>,</span>
<span>    dprior<span class="op">=</span><span class="va">dprior</span><span class="op">)</span></span>
<span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">5e-2</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">3e4</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu">MH_MCMC</span><span class="op">(</span><span class="va">x</span>,<span class="va">N</span>,eps<span class="op">=</span><span class="va">h</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">S</span>,<span class="st">"acceptanceRate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3267667</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/hexbin" class="external-link">hexbin</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/hexbin/man/hexplom.html" class="external-link">hexplom</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sampleAKAR4_files/figure-html/sample-1.png" width="1200"></p>
</div>
<div class="section level3">
<h3 id="better-sample">Better Sample<a class="anchor" aria-label="anchor" href="#better-sample"></a>
</h3>
<p>We can try to obtain a higher quality sample, through simple
means:</p>
<ol style="list-style-type: decimal">
<li>Combine several samples (replicas) into one big sample</li>
<li>Use several random starting locations</li>
<li>Remove burn-in phase from each chain</li>
<li>Adjust the step size at least once to get close to 25% acceptance
rate</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">+</span> <span class="va">a</span><span class="op">^</span><span class="fl">4</span><span class="op">/</span><span class="op">(</span><span class="fl">0.25</span><span class="op">^</span><span class="fl">4</span> <span class="op">+</span> <span class="va">a</span><span class="op">^</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">137</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">nCores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bigSample</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">nCores</span><span class="op">)</span>,</span>
<span>    \<span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcInit.html">mcmcInit</a></span><span class="op">(</span></span>
<span>            <span class="fl">1.0</span>,</span>
<span>            parMCMC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">rprior</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            simulate<span class="op">=</span><span class="va">s</span>,</span>
<span>            logLikelihood<span class="op">=</span><span class="va">llf</span>,</span>
<span>            dprior<span class="op">=</span><span class="va">dprior</span><span class="op">)</span></span>
<span>        <span class="co">## adjust acceptance rate to 25% via step-size h</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">MH_MCMC</span><span class="op">(</span><span class="va">x</span>,<span class="fl">200</span>,<span class="va">h</span><span class="op">)</span></span>
<span>            <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">z</span>,<span class="st">"lastPoint"</span><span class="op">)</span></span>
<span>            <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">h</span><span class="op">*</span><span class="fu">A</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">z</span>,<span class="st">"acceptanceRate"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">MH_MCMC</span><span class="op">(</span><span class="va">x</span>,<span class="va">N</span>,<span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    mc.cores<span class="op">=</span><span class="va">nCores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">S_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">a</span>,<span class="va">b</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">a</span>,<span class="va">b</span><span class="op">)</span><span class="op">}</span>,<span class="va">bigSample</span>,init<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">L_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">a</span>,<span class="va">b</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">a</span>,<span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">b</span>,<span class="st">"logLikelihood"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>,<span class="va">bigSample</span>,init<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">S_</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HISKP-LQCD/hadron" class="external-link">hadron</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">ac</span> <span class="op">&lt;-</span> <span class="fu">hadron</span><span class="fu">::</span><span class="fu">uwerr</span><span class="op">(</span>data<span class="op">=</span><span class="va">L_</span>,nrep<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">N</span>,<span class="va">nCores</span><span class="op">)</span>,pl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">ac</span><span class="op">$</span><span class="va">tauint</span><span class="op">+</span><span class="va">ac</span><span class="op">$</span><span class="va">dtauint</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">S_</span><span class="op">)</span>,by<span class="op">=</span><span class="va">tau</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">S_</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">L_</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"mcmc index"</span>,ylab<span class="op">=</span><span class="st">"log-likelihood"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sampleAKAR4_files/figure-html/betterSample-1.png" width="700"><img src="sampleAKAR4_files/figure-html/betterSample-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in arrows(c(2:Wmax), ti[2:Wmax] - dti[2:Wmax], c(2:Wmax), ti[2:Wmax] +</span></span>
<span><span class="co">#&gt; : zero-length arrow is of indeterminate angle and so skipped</span></span></code></pre>
<p><img src="sampleAKAR4_files/figure-html/betterSample-3.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/hexbin" class="external-link">hexbin</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">hexbin</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/hexbin/man/hexplom.html" class="external-link">hexplom</a></span><span class="op">(</span><span class="va">S_</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">S_</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sampleAKAR4_files/figure-html/pairs-2-1.png" width="1200"></p>
<p>The code above can of course also be done in a loop (sequentially),
and <code>rbind</code> within the loop.</p>
<p>Let us also plot the log-likelihood</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">L_</span>,main<span class="op">=</span><span class="st">"Big Sample for AKAR4"</span>,xlab<span class="op">=</span><span class="st">"Markov chain index"</span>,ylab<span class="op">=</span><span class="st">"log-likelihood"</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampleAKAR4_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>This should be enough for this model size to be used as a basis for
uncertainty quantification. For bigger models we turn to either more
advanced MCMC algorithms, such as <a href="smmala.html">SMMALA</a>or <a href="mpi.html">parallel tempering</a> combined with the
Metropolis-Hastings algorithm.</p>
</div>
<div class="section level3">
<h3 id="alternative-to-checkmodel">Alternative to <code>checkModel()</code><a class="anchor" aria-label="anchor" href="#alternative-to-checkmodel"></a>
</h3>
<p>The steps described above to compile the model with the
<code>checkModel</code> function can also be done outside of R, by
running an appropriate command, e.g.:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># alternative, directly in the shell:</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">cc</span> <span class="at">-shared</span> <span class="at">-fPIC</span> <span class="at">-o</span> AKAR4.so ./AKAR4_gvf.c <span class="at">-lgsl</span> <span class="at">-lgslcblas</span> <span class="at">-lm</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
