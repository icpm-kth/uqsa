<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chemical Reaction Neural Network (CRNN) • uqsa</title>
<script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Chemical Reaction Neural Network (CRNN)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uqsa.html">Get started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-installation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Installation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-installation">
<li><a class="dropdown-item" href="../articles/installation.html">Short Instructions</a></li>
    <li><a class="dropdown-item" href="../articles/installExplanations.html">Explanation for System Prerequisites</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-documentation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Documentation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-documentation">
<li><a class="dropdown-item" href="../articles/SBtab.html">SBtab</a></li>
    <li><a class="dropdown-item" href="../articles/models.html">Importing Models</a></li>
    <li><a class="dropdown-item" href="../articles/data.html">Importing Data</a></li>
    <li><a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/UQ.html">Uncertainty Quantification</a></li>
    <li><a class="dropdown-item" href="../articles/GSA.html">Global Sensitivity Analysis</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/more_details.html">More details...</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/examples_overview.html">Overview</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>AKAR4</h6></li>
    <li><a class="dropdown-item" href="../articles/simAKAR4.html">Simulate deterministic AKAR4</a></li>
    <li><a class="dropdown-item" href="../articles/simAKAR4stochastic.html">Simulate stochastic AKAR4</a></li>
    <li><a class="dropdown-item" href="../articles/sampleAKAR4.html">UQ on deterministic AKAR4</a></li>
    <li><a class="dropdown-item" href="../articles/sampleAKAR4stochastic.html">UQ on stochasic AKAR4</a></li>
    <li><a class="dropdown-item" href="../articles/GSA_AKAR4.html">GSA on AKAR4</a></li>
    <li><a class="dropdown-item" href="../articles/uqsaAKAR4.html">UQ and SA on AKAR4</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>AKAP79</h6></li>
    <li><a class="dropdown-item" href="../articles/sampleAKAP79.html">UQ on deterministic AKAP79</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>CaMKII</h6></li>
    <li><a class="dropdown-item" href="../articles/smmala.html">Calibrate CaMKII with SMMALA</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>CRNN</h6></li>
    <li><a class="dropdown-item" href="../articles/crnn.html">CRNN models</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extra</h6></li>
    <li><a class="dropdown-item" href="../articles/extraExamples.html">More examples...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Function reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Chemical Reaction Neural Network (CRNN)</h1>
            
      

      <div class="d-none name"><code>crnn.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="model-type">Model Type<a class="anchor" aria-label="anchor" href="#model-type"></a>
</h2>
<p>CRNNs, are a specific category of ordinary differential equations
(ODEs). The ODE is constrained in such a way that the right hand side
(vector field) function must map to a Neural Network (NN), but the
network structure remains general enough to encode many systems by
changing the parameters, without re-building the model.</p>
<p>The output of the CRNN is the right hand side function:</p>
<p><span class="math display">\[
\dot x(t) = CRNN(t,x,p)\,,
\]</span></p>
<p>where <span class="math inline">\(p\)</span> includes the kinetic
rate coefficients, the stoichiometry and information about catalytic
modifiers (reactants that are not consumed by the reaction).</p>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>We want to simulate these two reactions:</p>
<pre><code> A + B &lt;=&gt; C
     D &lt;=&gt; Ø</code></pre>
<div class="section level4">
<h4 id="conventional-approach-simplified">Conventional Approach (simplified)<a class="anchor" aria-label="anchor" href="#conventional-approach-simplified"></a>
</h4>
<p>The simple way to simulate exactly this model is to create a flux
<span class="math inline">\(v\)</span> from the law of MASS action:</p>
<p><span class="math display">\[
v(x,k) = \begin{pmatrix}
k_{1,\text{f}} A B - k_{1,\text{r}} C\\
k_{2,\text{f}} D - k_{2,\text{r}}
\end{pmatrix}
\]</span></p>
<p>Where the <span class="math inline">\(k\)</span> are kinetic rate
coefficients.</p>
<p>The stoichiometry of this system is:</p>
<p><span class="math display">\[
\nu = \begin{pmatrix}
-1 &amp; 0\\
-1 &amp; 0\\
1 &amp; 0\\
0 &amp; -1
\end{pmatrix}
\]</span></p>
<p>Finally, the system is:</p>
<p><span class="math display">\[
\dot x = \nu \cdot v(t,x,k)
\]</span></p>
<p>In R, this becomes:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="co"># reaction 1</span></span>
<span>        <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span> <span class="co"># reaction 2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fl">4</span>,<span class="fl">2</span>,</span>
<span>    dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>,<span class="st">"D"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A+B&lt;=&gt;C"</span>,<span class="st">"D-&gt;0"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">nu</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A+B&lt;=&gt;C D-&gt;0</span></span>
<span><span class="co">#&gt; A      -1    0</span></span>
<span><span class="co">#&gt; B      -1    0</span></span>
<span><span class="co">#&gt; C       1    0</span></span>
<span><span class="co">#&gt; D       0   -1</span></span></code></pre></div>
<p>Next we set the kinetic rate coefficients, but in logarithmic space
<code>l = log(k)</code>, we set them as a matrix, with the first column
containing all forward coefficients <span class="math inline">\(k_{\text{f}}\)</span>, and the second column all
reverse rates <span class="math inline">\(k_{\text{r}}\)</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span> <span class="co"># we have no modifiers</span></span>
<span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="co"># log(k)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>, <span class="co">#  forward</span></span>
<span>        <span class="op">-</span><span class="fl">2</span>,<span class="op">-</span><span class="fl">30</span> <span class="co"># backward</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fl">2</span>,<span class="fl">2</span>, <span class="co"># two reactions, fwd+bwd</span></span>
<span>    dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A+B&lt;=&gt;C"</span>,<span class="st">"D&lt;=&gt;0"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fwd"</span>,<span class="st">"bwd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span><span class="co">#&gt;         fwd bwd</span></span>
<span><span class="co">#&gt; A+B&lt;=&gt;C  -1  -2</span></span>
<span><span class="co">#&gt; D&lt;=&gt;0    -1 -30</span></span>
<span></span>
<span><span class="co">## initial values:</span></span>
<span><span class="va">iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A<span class="op">=</span><span class="fl">2.1</span>,B<span class="op">=</span><span class="fl">1.1</span>,C<span class="op">=</span><span class="fl">0.1</span>,D<span class="op">=</span><span class="fl">3.0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we collect all parameters into a list:</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>l<span class="op">=</span><span class="va">l</span>,nu<span class="op">=</span><span class="va">nu</span>,m<span class="op">=</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>Here, we made the second reaction almost irreversible:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k</span><span class="op">[</span><span class="fl">2</span>,<span class="st">'bwd'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span><span class="op">)</span> <span class="co"># ~1e-13</span></span></code></pre></div>
<p>Next, we define the vector field and Jacobin (the ODE):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manual_jac</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,<span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">l</span><span class="op">)</span></span>
<span>    <span class="va">dflux_dy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>            <span class="va">k</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'B'</span><span class="op">]</span>,<span class="va">k</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'A'</span><span class="op">]</span>,<span class="op">-</span><span class="va">k</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">0</span>,</span>
<span>            <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="va">k</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>        ,<span class="fl">2</span>,<span class="fl">4</span>,</span>
<span>        byrow<span class="op">=</span><span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">J</span> <span class="op">&lt;-</span> <span class="va">par</span><span class="op">$</span><span class="va">nu</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">dflux_dy</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## kinetic laws hard-coded into vf, changing nu will make this wrong:</span></span>
<span><span class="va">manual_vf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,<span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">l</span><span class="op">)</span></span>
<span>    <span class="va">flux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">k</span><span class="op">[</span><span class="fl">1</span>,<span class="st">'fwd'</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'A'</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'B'</span><span class="op">]</span> <span class="op">-</span> <span class="va">k</span><span class="op">[</span><span class="fl">1</span>,<span class="st">'bwd'</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'C'</span><span class="op">]</span>,<span class="va">k</span><span class="op">[</span><span class="fl">2</span>,<span class="st">'fwd'</span><span class="op">]</span><span class="op">*</span><span class="va">y</span><span class="op">[</span><span class="st">'D'</span><span class="op">]</span><span class="op">-</span><span class="va">k</span><span class="op">[</span><span class="fl">2</span>,<span class="st">'bwd'</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">nu</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">flux</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>These two functions are not very general, any changes to <span class="math inline">\(\nu\)</span> must be considered in the flux
expressions. These functions hard-code the model’s structure at least
partially.</p>
<p>We could use <code>vf</code> and <code>jac</code> with deSolve (with
some modification), but since it is a very small system we can obtain a
fairly good solution with Euler forward steps (ignoring the Jacobin
entirely):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">iv</span>     <span class="co"># initialize</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>   <span class="co"># time step</span></span>
<span><span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span>,by<span class="op">=</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Y</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">manual_vf</span><span class="op">(</span><span class="va">tm</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,<span class="va">y</span>,<span class="va">par</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">+</span><span class="va">f</span><span class="op">*</span><span class="va">dt</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    <span class="va">tm</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="st">"l"</span>,</span>
<span>    xlab<span class="op">=</span><span class="st">"time"</span>,</span>
<span>    ylab<span class="op">=</span><span class="st">"states"</span>,</span>
<span>    lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>    col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span>,</span>
<span>    ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    main<span class="op">=</span><span class="st">"manual Euler forward"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>    <span class="st">"topright"</span>,</span>
<span>    legend<span class="op">=</span><span class="va">LETTERS</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>    col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="crnn_files/figure-html/Euler-1.png" width="100%"></p>
</div>
<div class="section level4">
<h4 id="crnn-variant">CRNN Variant<a class="anchor" aria-label="anchor" href="#crnn-variant"></a>
</h4>
<p>The same system can be written as a CRNN, more generally:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">numReactions</span> <span class="op">&lt;-</span> <span class="fl">2</span>                    <span class="co"># this has to be manually set</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>LogSum<span class="op">=</span><span class="st">"log(A+B+C+D)"</span><span class="op">)</span>        <span class="co"># an arbitrary output function</span></span>
<span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRNN.html">CRNN</a></span><span class="op">(</span><span class="va">numReactions</span>,<span class="va">iv</span>,<span class="va">f</span><span class="op">)</span>         <span class="co"># C code</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">C</span>,sep<span class="op">=</span><span class="st">"\n"</span>,file<span class="op">=</span><span class="st">"CRNN.c"</span><span class="op">)</span>                  <span class="co"># write code to file</span></span>
<span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"CRNN"</span>,<span class="st">"CRNN.c"</span><span class="op">)</span> <span class="co"># compile</span></span>
<span><span class="co">#&gt; building a shared library from c source, and using GSL odeiv2 as backend (pkg-config is used here).</span></span>
<span><span class="co">#&gt; cc -shared -fPIC `pkg-config --cflags gsl` -o './CRNN.so' 'CRNN.c' `pkg-config --libs gsl`</span></span></code></pre></div>
<p>Next we define the simulation experiment:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        initialState<span class="op">=</span><span class="va">iv</span>,</span>
<span>        outputTimes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span>,by<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        initialTime<span class="op">=</span><span class="fl">0.0</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>uqsa</code> package provides a function that returns a
closure around the model and experiment, similar to conventional ODEs.
But, in this case, we want to be able to switch between different
integration methods, so we use the solver more explicitly:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">M</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gsl_odeiv2_CRNN.html">gsl_odeiv2_CRNN</a></span><span class="op">(</span></span>
<span>        <span class="va">modelName</span>,</span>
<span>        experiments<span class="op">=</span><span class="va">ex</span>,</span>
<span>        l<span class="op">=</span><span class="va">l</span>,</span>
<span>        nu<span class="op">=</span><span class="va">nu</span>,</span>
<span>        m<span class="op">=</span><span class="va">m</span>,</span>
<span>        method<span class="op">=</span><span class="va">M</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>        <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        type<span class="op">=</span><span class="st">"l"</span>,</span>
<span>        xlab<span class="op">=</span><span class="st">"time"</span>,</span>
<span>        ylab<span class="op">=</span><span class="st">"states"</span>,</span>
<span>        lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>        col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span>,</span>
<span>        ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        main<span class="op">=</span><span class="fu">rgsl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgsl/man/nameMethod.html" class="external-link">nameMethod</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="crnn_files/figure-html/solve-1.png" width="100%"></p>
</div>
<div class="section level4">
<h4 id="mcmc-and-repeated-calls-to-the-solver">MCMC and repeated Calls to the solver<a class="anchor" aria-label="anchor" href="#mcmc-and-repeated-calls-to-the-solver"></a>
</h4>
<p>In an MCMC context, we typically don’t want to switch between
methods, so we would create a closure:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scrnn.html">scrnn</a></span><span class="op">(</span><span class="va">ex</span>,<span class="va">modelName</span><span class="op">)</span>  <span class="co"># s encloses ex, and model</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">s</span><span class="op">(</span><span class="va">par</span><span class="op">)</span>               <span class="co"># a function of par only</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="st">"l"</span>,</span>
<span>    xlab<span class="op">=</span><span class="st">"time"</span>,</span>
<span>    ylab<span class="op">=</span><span class="st">"states"</span>,</span>
<span>    lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>    col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span>,</span>
<span>    ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    main<span class="op">=</span><span class="fu">rgsl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgsl/man/nameMethod.html" class="external-link">nameMethod</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="crnn_files/figure-html/MCMC-1.png" width="100%"></p>
<p>Here, <code>s(par)</code> can be called repeatedly, with various
<code>par</code>, without re-stating which experiments to simulate or
which model to use. But, crucially, changing <code>par$nu</code> will be
correctly handled by the CRNN, the flux and Jacobin will change
accordingly.</p>
</div>
<div class="section level4">
<h4 id="changed-reaction-system">Changed Reaction System<a class="anchor" aria-label="anchor" href="#changed-reaction-system"></a>
</h4>
<p>The code <code>C</code> we generated for two reactions and four state
variables is general enough to depict every system that has two MASS
action reactions and four reacting compounds. We can easily change it
to:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## now, A+B also create D</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>, <span class="co">#   A + B &lt;=&gt; D + C</span></span>
<span>        <span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span>   <span class="co">#       D &lt;=&gt; Ø</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fl">4</span>,<span class="fl">2</span>,</span>
<span>    dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>,<span class="st">"D"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A+B&lt;=&gt;C+D"</span>,<span class="st">"D-&gt;0"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, this is just a parameter change. We simulate without generating
any new code:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">s</span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="st">"l"</span>,</span>
<span>    xlab<span class="op">=</span><span class="st">"time"</span>,</span>
<span>    ylab<span class="op">=</span><span class="st">"states"</span>,</span>
<span>    lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>    col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span>,</span>
<span>    ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    main<span class="op">=</span><span class="fu">rgsl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgsl/man/nameMethod.html" class="external-link">nameMethod</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>    <span class="st">"topright"</span>,</span>
<span>    legend<span class="op">=</span><span class="va">LETTERS</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    lty<span class="op">=</span><span class="fl">1</span>,</span>
<span>    col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red4"</span>,<span class="st">"blue4"</span>,<span class="st">"purple"</span>,<span class="st">"green4"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="crnn_files/figure-html/changed-par-1.png" width="100%"></p>
<p>The dynamics changed correctly.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
