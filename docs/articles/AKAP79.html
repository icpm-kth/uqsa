<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Example-AKAP79 • uqsa</title>
<script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example-AKAP79">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="file:///usr/share/javascript/mathjax/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
    <a class="dropdown-item" href="../articles/installExplanations.html">Explanation for System Prerequisites</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/uq.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/sa.html">Sensitivity Analysis</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Model and data management</h6>
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing Models</a>
    <a class="dropdown-item" href="../articles/data.html">Importing Data</a>
    <a class="dropdown-item" href="../articles/user_model.html">Build your own Model</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Paremeter estimation and uncertainty quantification</h6>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a Model</a>
    <a class="dropdown-item" href="../articles/ABC_sampling.html">ABC Sampling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sensitivity Analysis</h6>
    <a class="dropdown-item" href="../articles/GSA.html">Global Sensitivity Analysis</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <a class="dropdown-item" href="../articles/simAKAP79.html">Simulate AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAP79.html">Sample AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAR4.html">Sample AKAR4</a>
    <a class="dropdown-item" href="../articles/shortMakeSharedLibrary.html">Build a Model</a>
    <a class="dropdown-item" href="../articles/mpi.html">Multiple chains via MPI</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Example-AKAP79</h1>
            
      
      
      <div class="d-none name"><code>AKAP79.Rmd</code></div>
    </div>

    
    
<p>This example covers the AKAP79 example model and <code>rgsl</code> as
solver backend, alternatively, it is possible to use
<code>deSolve</code> instead (but not covered here).</p>
<p>We use <code>icpm-kth/SBtabVFGEN</code> to read the model files and
<code>icpm-kth/rgsl</code> as an interface to <code>gsl_odeiv2</code>
solvers (for initial value problems) to simulate the model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: SBtabVFGEN</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">rgsl</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: rgsl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: parallel</span></span></code></pre></div>
<p>Next, we import the model’s data tables from the SBtab files:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,<span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,pat<span class="op">=</span><span class="st">"gvf[.]c$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="va">modelName</span>,pat<span class="op">=</span><span class="st">"[.]tsv$"</span><span class="op">)</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span>
<span><span class="va">experiments</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">SBtab</span><span class="op">)</span></span></code></pre></div>
<p>The function <code>checkModel</code> checks that the model files
exist and compiles the model to a shared library using a c compiler, the
gsl library needs to be installed on the system for this to work (file
ending in <code>.so</code>). On windows, it is easier to use the
<code>deSolve</code> solvers.</p>
<p>The <code>model</code> variable contains the tabulated properties of
the model as a <code>list</code> of <code>data.frames</code>. The source
files of the model <code>AKAP79.R</code>, <code>AKAP79.vf</code>, and
<code>AKAP79_gvf.c</code> were all created automatically from the
tables. Because they are tables, we can retrieve default values from
them.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parVal</span> <span class="op">&lt;-</span> <span class="va">SBtab</span><span class="op">$</span><span class="va">Parameter</span><span class="op">[[</span><span class="st">"!DefaultValue"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>We have also defined a function that will transform the sampling
variables <code>parABC</code> used by the ABC method into something that
the model will accept as parameters. The plan is to sample in
logarithmic space: the ABC algorithm will sample the logarithms of the
model parameters. We limit the sampling to ranges, as appropriate for
each parameter:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">defRange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1000</span>,<span class="fl">19</span><span class="op">)</span>,<span class="fl">1.9</span>,<span class="fl">1000</span>,<span class="fl">1.25</span>,<span class="fl">1.25</span>,<span class="fl">1.25</span>,<span class="fl">1.5</span>,<span class="fl">1.5</span>,<span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define Lower and Upper Limits for logUniform prior distribution for the parameters</span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="va">parVal</span><span class="op">/</span><span class="va">defRange</span></span>
<span></span>
<span><span class="va">ul</span> <span class="op">&lt;-</span> <span class="va">parVal</span><span class="op">*</span><span class="va">defRange</span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span> <span class="co"># log10-scale</span></span>
<span><span class="va">ul</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">ul</span><span class="op">)</span> <span class="co"># log10-scale</span></span></code></pre></div>
<p>The sampling procedure takes data in the list of
<code>experiments</code> and compares the data points to the solution
that <code>gsl_odeiv2</code> returns. We define a list of experiments,
subdividing them into smaller groups and processing the groups in
sequence. Between the rounds of sampling the posterior of every result
is used as the prior distribution of the next round. This mimics the
arrival of data sets in sequence (from the lab). The intermediate
distributions will be modelled using <code>VineCopula</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">experimentsIndices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">12</span>,<span class="fl">18</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">11</span>, <span class="fl">17</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">16</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Problem Size and core distribution:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ns</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># Size of the sub-sample from each chain</span></span>
<span><span class="va">npc</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># pre-calibration sample size</span></span>
<span></span>
<span><span class="va">nChains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">nCores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nCoresPerChain</span> <span class="op">&lt;-</span> <span class="va">nCores</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">nChains</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores<span class="op">=</span><span class="va">nCoresPerChain</span><span class="op">)</span></span></code></pre></div>
<p>ABC related settings:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7619201</span><span class="op">)</span></span>
<span></span>
<span><span class="va">distanceMeasure</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">funcSim</span>, <span class="va">dataExpr</span><span class="op">=</span><span class="cn">Inf</span>, <span class="va">dataErr</span><span class="op">=</span><span class="cn">Inf</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">funcSim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">71.67</span><span class="op">*</span><span class="op">(</span><span class="va">funcSim</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dataExpr</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dataErr</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">distance</span> <span class="op">&lt;-</span> <span class="cn">Inf</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We also setup a convenience function which saves the sampled values
to a file:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">save_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ind</span>,<span class="va">ABCMCMCoutput</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">ind</span>, collapse<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span>
<span>    <span class="va">timeStr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">timeStr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">":"</span>,<span class="st">"_"</span>, <span class="va">timeStr</span><span class="op">)</span></span>
<span>    <span class="va">timeStr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" "</span>,<span class="st">"_"</span>, <span class="va">timeStr</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"./PosteriorSamples"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"./PosteriorSamples"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">outFileR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"./PosteriorSamples/Draws"</span>,<span class="va">modelName</span>,<span class="st">"nChains"</span>,<span class="va">nChains</span>,<span class="st">"ns"</span>,<span class="va">ns</span>,<span class="st">"npc"</span>,<span class="va">npc</span>,<span class="va">I</span>,<span class="va">timeStr</span>,<span class="st">".RData"</span>,collapse<span class="op">=</span><span class="st">"_"</span>,sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">ABCMCMCoutput</span>, file<span class="op">=</span><span class="va">outFileR</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Build a random number generator, and density function for the intial
prior:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rUniformPrior.html">rUniformPrior</a></span><span class="op">(</span><span class="va">ll</span>, <span class="va">ul</span><span class="op">)</span></span>
<span><span class="va">dprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dUniformPrior.html">dUniformPrior</a></span><span class="op">(</span><span class="va">ll</span>, <span class="va">ul</span><span class="op">)</span></span></code></pre></div>
<p>The sampling loop:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">experimentsIndices</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">expInd</span> <span class="op">&lt;-</span> <span class="va">experimentsIndices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">objectiveFunction</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeObjective.html">makeObjective</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="va">expInd</span><span class="op">]</span>, <span class="va">modelName</span>, <span class="va">distanceMeasure</span>, <span class="va">log10ParMap</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="va">nCores</span><span class="op">)</span></span>
<span>    <span class="va">pC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preCalibration.html">preCalibration</a></span><span class="op">(</span><span class="va">objectiveFunction</span>, <span class="va">npc</span>, <span class="va">rprior</span><span class="op">)</span></span>
<span>    <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getMCMCPar.html">getMCMCPar</a></span><span class="op">(</span><span class="va">pC</span><span class="op">$</span><span class="va">prePar</span>, <span class="va">pC</span><span class="op">$</span><span class="va">preDelta</span>, delta<span class="op">=</span><span class="va">delta</span>, num <span class="op">=</span> <span class="va">nChains</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="va">nCoresPerChain</span><span class="op">)</span></span>
<span>    <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeForkCluster</a></span><span class="op">(</span><span class="va">nChains</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"objectiveFunction"</span>, <span class="st">"M"</span>, <span class="st">"ns"</span>, <span class="st">"delta"</span>, <span class="st">"dprior"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">out_ABCMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="va">nChains</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu"><a href="../reference/ABCMCMC.html">ABCMCMC</a></span><span class="op">(</span><span class="va">objectiveFunction</span>, <span class="va">M</span><span class="op">$</span><span class="va">startPar</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">ns</span>, <span class="va">M</span><span class="op">$</span><span class="va">Sigma</span>, <span class="va">delta</span>, <span class="va">dprior</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">ABCMCMCoutput</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">Map</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rbind</span>,<span class="va">out_ABCMCMC</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitCopula.html">fitCopula</a></span><span class="op">(</span><span class="va">ABCMCMCoutput</span><span class="op">$</span><span class="va">draws</span>, <span class="va">nCoresPerChain</span><span class="op">)</span></span>
<span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># Keep the draws that also fit the experiments considered in previous loops</span></span>
<span></span>
<span>      <span class="va">objectiveFunction</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeObjective.html">makeObjective</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">experimentsIndices</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>, <span class="va">modelName</span>, <span class="va">distanceMeasure</span>, <span class="va">log10ParMap</span><span class="op">)</span></span>
<span>      <span class="co"># We relax the delta from 0.01 to 0.05</span></span>
<span>      <span class="va">ABCMCMCoutput</span><span class="op">$</span><span class="va">drawsAfterCheckFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkFitWithPreviousExperiments.html">checkFitWithPreviousExperiments</a></span><span class="op">(</span><span class="va">ABCMCMCoutput</span><span class="op">$</span><span class="va">draws</span>,<span class="va">objectiveFunction</span>,delta <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>    <span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitCopula.html">fitCopula</a></span><span class="op">(</span><span class="va">ABCMCMCoutput</span><span class="op">$</span><span class="va">drawsAfterCheckFit</span>, <span class="va">nCoresPerChain</span><span class="op">)</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu">save_sample</span><span class="op">(</span><span class="va">expInd</span>,<span class="va">ABCMCMCoutput</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rCopulaPrior.html">rCopulaPrior</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span></span>
<span>    <span class="va">dprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dCopulaPrior.html">dCopulaPrior</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">end_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">time_</span> <span class="op">=</span> <span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total time:\n"</span>,<span class="va">time_</span><span class="op">)</span></span></code></pre></div>
<p>The sampling loop ran for ~24.5 minutes on a machine with the
following specs:</p>
<table class="table">
<thead><tr class="header">
<th align="right">MacBook Pro</th>
<th align="left">(13-inch, M1, 2020)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">Chip:</td>
<td align="left">Apple M1</td>
</tr>
<tr class="even">
<td align="right">Memory:</td>
<td align="left">16 GB</td>
</tr>
</tbody>
</table>
<p>The result is a collection of intermediate samples (2 files) and a
final posterior sample (1 file).</p>
<p>Here we plot data from experimental time series with simulations from
a subsample of the draws from the posterior distribution.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="va">ABCMCMCoutput</span><span class="op">$</span><span class="va">drawsAfterCheckFit</span></span>
<span></span>
<span><span class="va">simulate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">experimentsIndices</span><span class="op">)</span><span class="op">]</span>,<span class="va">modelName</span>,<span class="va">log10ParMap</span>, noise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">output_yy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">draws</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/plotTimeSeries.html">plotTimeSeries</a></span><span class="op">(</span><span class="va">output_yy</span>,<span class="va">experiments</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">experimentsIndices</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
