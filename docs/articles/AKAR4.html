<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Sample AKAR4 via ABC â€¢ uqsa</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sample AKAR4 via ABC">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
    <a class="dropdown-item" href="../articles/installExplanations.html">Explanation for System Prerequisites</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing Models</a>
    <a class="dropdown-item" href="../articles/data.html">Importing Data</a>
    <a class="dropdown-item" href="../articles/events.html">Transformation Events</a>
    <a class="dropdown-item" href="../articles/user_model.html">Build your own Model</a>
    <a class="dropdown-item" href="../articles/generateCodeInR.html">Generate Model Code</a>
    <a class="dropdown-item" href="../articles/intermediateFiles.html">Advantages of Intermediates</a>
    <a class="dropdown-item" href="../articles/ODE-Model.html">ODE Model</a>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a Model</a>
    <a class="dropdown-item" href="../articles/mpi.html">Multiple chains via MPI</a>
    <a class="dropdown-item" href="../articles/GSA.html">Global Sensitivity Analysis</a>
    <a class="dropdown-item" href="../articles/UQ.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/sa.html">Sensitivity Analysis</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAR4</h6>
    <a class="dropdown-item" href="../articles/simAKAR4.html">Simulate deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/simAKAR4stochastic.html">Simulate stochastic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4.html">UQ on deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4mpi.html">UQ on deterministic AKAR4 with MPI</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4stochastic.html">UQ on stochasic AKAR4</a>
    <a class="dropdown-item" href="../articles/GSA_AKAR4.html">GSA on AKAR4</a>
    <a class="dropdown-item" href="../articles/uqsaAKAR4.html">UQ and SA on AKAR4</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAP79</h6>
    <a class="dropdown-item" href="../articles/sampleAKAP79.html">UQ on deterministic AKAP79</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>CaMKII</h6>
    <a class="dropdown-item" href="../articles/smmala.html">Calibrate CaMKII with SMMALA</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Extra</h6>
    <a class="dropdown-item" href="../articles/extraExamples.html">More examples...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Sample AKAR4 via ABC</h1>
            
      
      
      <div class="d-none name"><code>AKAR4.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgsl</span><span class="op">)</span></span></code></pre></div>
<p>We load the model from a collection of TSV files
(<code>inst/extdata/AKAR4</code> on github), the function below locates
the tsv files after package installation:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4"</span>,full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Then we import the contents as a list of <code>data.frames</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span> <span class="co"># SBtabVFGEN</span></span>
<span><span class="co">#&gt; [tsv] file[1] Â«AKAR4_100nM.tsvÂ» belongs to Document Â«AKAR4Â»</span></span>
<span><span class="co">#&gt;  I'll take this as the Model Name.</span></span>
<span><span class="co">#&gt; AKAR4_100nM.tsv  AKAR4_25nM.tsv  AKAR4_400nM.tsv  AKAR4_Compound.tsv  AKAR4_Experiments.tsv  AKAR4_Output.tsv  AKAR4_Parameter.tsv  AKAR4_Reaction.tsv</span></span></code></pre></div>
<p>We load the R functions of the model (e.g.Â the jacobian of the
model):</p>
<ul>
<li>
<code>AKAR4_vf</code>, the vector field,</li>
<li>
<code>AKAR4_jac</code>, the jacobian,</li>
<li>
<code>AKAR4_default</code>, the default parameters</li>
</ul>
<p>The R file we source additionally includes a variable called
<code>model</code>, which serves the purpose of having generic names for
all model constituents, to make it easier to write generic scripts:</p>
<ul>
<li>
<code>model$vf()</code> corresponds to <code>AKAR4_vf()</code>
<ul>
<li>but does not use AKAR4 in the name</li>
<li>otherwise identical</li>
</ul>
</li>
<li>
<code>model$jac()</code> corresponds to
<code>AKAR4_jac()</code>
</li>
<li>
<code>model$name</code> is a string, <code>"AKAR4"</code> in this
case</li>
</ul>
<p>This can help to write fairly general scripts where the modelâ€™s name
appears only at the top. You can investigate the sourced file to find
out more.</p>
<p>Generally, <code>model</code> is a list of functions, one of which is
called <code>model$par()</code> and returns the default parameters of
the model in linear space:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4"</span>,pat<span class="op">=</span><span class="st">"^AKAR4[.]R$"</span><span class="op">)</span><span class="op">)</span> <span class="co"># loads "model"</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="va">name</span>   <span class="co"># AKAR4</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "AKAR4"</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">par</span><span class="op">(</span><span class="op">)</span>  <span class="co"># default values for parameters</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; kf_C_AKAR4 kb_C_AKAR4 kcat_AKARp </span></span>
<span><span class="co">#&gt;      0.018      0.106     10.200</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">init</span><span class="op">(</span><span class="op">)</span> <span class="co"># default initial values for ODE state variables</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   AKAR4 AKAR4_C  AKAR4p       C </span></span>
<span><span class="co">#&gt;     0.2     0.0     0.0     0.0</span></span></code></pre>
<p>The model exists in R and C form: - <code>AKAR4.R</code> -
<code>AKAR4_gvf.c</code></p>
<p>The file ending in <code>_gvf.c</code> contains functions used for
simulations with <code><a href="https://rdrr.io/pkg/rgsl/man/r_gsl_odeiv2_outer.html" class="external-link">rgsl::r_gsl_odeiv2_outer()</a></code>
(<code>_gvf.c</code> needs to be compiled to a shared library). The
functions in <code>.R</code> can be used more freely in R, and are
functionally identical (they describe the same model, but solutions are
slower in R).</p>
<p>The next function call checks that the model <code>[...]_gvf.c</code>
file exist, and builds a shared library <code>.so</code> from these
sources. It attaches a comment to its return value that indicates how
the shared library for this model is named:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAR4"</span>,<span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4"</span>,pat<span class="op">=</span><span class="st">"_gvf[.]c$"</span><span class="op">)</span><span class="op">)</span> <span class="co"># SBtabVFGEN</span></span>
<span><span class="co">#&gt; building a shared library from c source, and using GSL odeiv2 as backend (pkg-config is used here).</span></span>
<span><span class="co">#&gt; cc -shared -fPIC `pkg-config --cflags gsl` -o './AKAR4.so' '/home/andrei/R/library/uqsa/extdata/AKAR4/AKAR4_gvf.c' `pkg-config --libs gsl`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/comment.html" class="external-link">comment</a></span><span class="op">(</span><span class="va">modelName</span><span class="op">)</span> <span class="co"># should be AKAR4.so</span></span>
<span><span class="co">#&gt; [1] "./AKAR4.so"</span></span></code></pre></div>
<p>The comment will be used to find the <code>.so</code> file (if you
move that file, adjust the comment on the <code>modelName</code>).</p>
<p>We want to sample in logarithmic space, so we set up a mapping
function <code>parMap</code>. The sampler will call this function on the
sampling variable <code>parABC</code> before it simulates the model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parMap</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">parABC</span><span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="va">parABC</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The ODE model receives a parameter vector <code>p</code> for each
experiment. It consists of the biological model parameters (which are
the same for all experiments), and input parameters (which together with
initial conditions distinguish the experimental setups). This model
doesnâ€™t have input parameters, so the biological and ODE parameters are
the same. Otherwise, two different kinds of parameters are concatenated
into one big numeric vector inside of the solver. The model function
<code>AKAR4_default()</code> returns the default values for
<code>p</code>.</p>
<p>Next, we load the list of experiments from the same list of
<code>data.frames</code> (SBtab content):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">experiments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">SBtab</span><span class="op">)</span></span>
<span><span class="va">parVal</span> <span class="op">&lt;-</span> <span class="fu">AKAR4_default</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span><span class="co">#&gt; kf_C_AKAR4 kb_C_AKAR4 kcat_AKARp </span></span>
<span><span class="co">#&gt;      0.018      0.106     10.200</span></span></code></pre></div>
<p>Define lower and upper limits for log-uniform prior distribution for
the parameters:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span> <span class="op">-</span> <span class="fl">3</span></span>
<span><span class="va">ul</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span></span></code></pre></div>
<p>Define Number of Samples for the pre-calibration <code>npc</code> and
each ABC-MCMC chain <code>ns</code>. During ABC, we save every 100-th
point, so <code>work(nChains*ns*100) â‰ˆ work(npc)</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ns</span> <span class="op">&lt;-</span> <span class="fl">2500</span>  <span class="co"># ABC-MCMC sample size</span></span>
<span><span class="va">npc</span> <span class="op">&lt;-</span> <span class="fl">50000</span> <span class="co"># pre-calibration size</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.02</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">nCores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores<span class="op">=</span><span class="va">nCores</span><span class="op">)</span></span></code></pre></div>
<p>We define a function that measures the distance between experiment
and simulation:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distanceMeasure</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">funcSim</span>, <span class="va">dataExpr</span>, <span class="va">dataErr</span> <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">funcSim</span><span class="op">-</span><span class="va">dataExpr</span><span class="op">$</span><span class="va">AKAR4pOUT</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dataExpr</span><span class="op">$</span><span class="va">AKAR4pOUT</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If the data is very informative, then the difference between the
prior and posterior are large. In such cases, it may be difficult to
find the posterior through sampling. Dividing the data into chunks and
processing them sequentially can help. Our model of the posterior of
previous chunks is based on Copulas and the <code>VineCopula</code>
package.</p>
<p>We divide the workload into chunks and loop over the chunks in th
ecode block below.</p>
<p>The ABCMCMC function returns 1% of all sampled points, because of the
very low acceptance rates of the ABC method. This is the reason for the
comparatively low sample size request <code>ns</code>: the simulation
workload will be proportional to <code>100*ns</code>. But the returned
sample is of a very high quality, with very low apparent
auto-correlation (because we omitted the large number of repeated
points).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">priorPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dUniformPrior.html">dUniformPrior</a></span><span class="op">(</span><span class="va">ll</span>, <span class="va">ul</span><span class="op">)</span></span>
<span><span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rUniformPrior.html">rUniformPrior</a></span><span class="op">(</span><span class="va">ll</span>, <span class="va">ul</span><span class="op">)</span></span>
<span></span>
<span><span class="va">start_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">chunks</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">expInd</span> <span class="op">&lt;-</span> <span class="va">chunks</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">simulate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="va">expInd</span><span class="op">]</span>,<span class="va">modelName</span>,<span class="va">parMap</span>,noise<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">Obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeObjective.html">makeObjective</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="va">expInd</span><span class="op">]</span>,<span class="va">modelName</span>,<span class="va">distanceMeasure</span>,<span class="va">parMap</span>,<span class="va">simulate</span><span class="op">)</span></span>
<span>    <span class="va">time_pC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">pC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preCalibration.html">preCalibration</a></span><span class="op">(</span><span class="va">Obj</span>, <span class="va">npc</span>, <span class="va">rprior</span>, rep<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">time_pC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">time_pC</span>,units<span class="op">=</span><span class="st">"secs"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\t - time spent on precalibration: %g seconds\n"</span>,<span class="va">time_pC</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">time_ABC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ABCMCMC.html">ABCMCMC</a></span><span class="op">(</span><span class="va">Obj</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pC</span><span class="op">$</span><span class="va">startPar</span><span class="op">)</span>, <span class="va">ns</span>, <span class="va">pC</span><span class="op">$</span><span class="va">Sigma</span>, <span class="va">delta</span>, <span class="va">priorPDF</span><span class="op">)</span></span>
<span>    <span class="va">time_ABC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">time_ABC</span>,units<span class="op">=</span><span class="st">"mins"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\t - time spent on ABC-MCMC: %g minutes\n"</span>,<span class="va">time_ABC</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">simulate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="va">chunks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>,<span class="va">modelName</span>,<span class="va">parMap</span><span class="op">)</span></span>
<span>        <span class="va">Obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeObjective.html">makeObjective</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[</span><span class="va">chunks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>,<span class="va">modelName</span>,<span class="va">distanceMeasure</span>,<span class="va">parMap</span>,<span class="va">simulate</span><span class="op">)</span></span>
<span>        <span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkFitWithPreviousExperiments.html">checkFitWithPreviousExperiments</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span>, <span class="va">Obj</span>, <span class="va">delta</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitCopula.html">fitCopula</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span></span>
<span>    <span class="va">priorPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dCopulaPrior.html">dCopulaPrior</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span></span>
<span>    <span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rCopulaPrior.html">rCopulaPrior</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning in getMCMCPar(prePar, preDelta, p = p, sfactor = sfactor, delta = delta, : distances between experiment and simulation are too big; selecting the best (50000) parameter vectors.</span></span></code></pre>
<pre><code><span><span class="co">#&gt;   - time spent on precalibration: 35.4065 seconds</span></span>
<span><span class="co">#&gt; Started chain.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; n = 10000</span></span>
<span><span class="co">#&gt; n = 20000</span></span>
<span><span class="co">#&gt; n = 30000</span></span>
<span><span class="co">#&gt; n = 40000</span></span>
<span><span class="co">#&gt; n = 50000</span></span>
<span><span class="co">#&gt; n = 60000</span></span>
<span><span class="co">#&gt; n = 70000</span></span>
<span><span class="co">#&gt; n = 80000</span></span>
<span><span class="co">#&gt; n = 90000</span></span>
<span><span class="co">#&gt; n = 1e+05</span></span>
<span><span class="co">#&gt; n = 110000</span></span>
<span><span class="co">#&gt; n = 120000</span></span>
<span><span class="co">#&gt; n = 130000</span></span>
<span><span class="co">#&gt; n = 140000</span></span>
<span><span class="co">#&gt; n = 150000</span></span>
<span><span class="co">#&gt; n = 160000</span></span>
<span><span class="co">#&gt; n = 170000</span></span>
<span><span class="co">#&gt; n = 180000</span></span>
<span><span class="co">#&gt; n = 190000</span></span>
<span><span class="co">#&gt; n = 2e+05</span></span>
<span><span class="co">#&gt; n = 210000</span></span>
<span><span class="co">#&gt; n = 220000</span></span>
<span><span class="co">#&gt; n = 230000</span></span>
<span><span class="co">#&gt; n = 240000</span></span>
<span><span class="co">#&gt; n = 250000    - time spent on ABC-MCMC: 42.7174 minutes</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Warning in getMCMCPar(prePar, preDelta, p = p, sfactor = sfactor, delta = delta, : distances between experiment and simulation are too big; selecting the best (50000) parameter vectors.</span></span></code></pre>
<pre><code><span><span class="co">#&gt;   - time spent on precalibration: 25.4763 seconds</span></span>
<span><span class="co">#&gt; Started chain.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; n = 10000</span></span>
<span><span class="co">#&gt; n = 20000</span></span>
<span><span class="co">#&gt; n = 30000</span></span>
<span><span class="co">#&gt; n = 40000</span></span>
<span><span class="co">#&gt; n = 50000</span></span>
<span><span class="co">#&gt; n = 60000</span></span>
<span><span class="co">#&gt; n = 70000</span></span>
<span><span class="co">#&gt; n = 80000</span></span>
<span><span class="co">#&gt; n = 90000</span></span>
<span><span class="co">#&gt; n = 1e+05</span></span>
<span><span class="co">#&gt; n = 110000</span></span>
<span><span class="co">#&gt; n = 120000</span></span>
<span><span class="co">#&gt; n = 130000</span></span>
<span><span class="co">#&gt; n = 140000</span></span>
<span><span class="co">#&gt; n = 150000</span></span>
<span><span class="co">#&gt; n = 160000</span></span>
<span><span class="co">#&gt; n = 170000</span></span>
<span><span class="co">#&gt; n = 180000</span></span>
<span><span class="co">#&gt; n = 190000</span></span>
<span><span class="co">#&gt; n = 2e+05</span></span>
<span><span class="co">#&gt; n = 210000</span></span>
<span><span class="co">#&gt; n = 220000</span></span>
<span><span class="co">#&gt; n = 230000</span></span>
<span><span class="co">#&gt; n = 240000</span></span>
<span><span class="co">#&gt; n = 250000    - time spent on ABC-MCMC: 30.2787 minutes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -Checking fit with previous data</span></span>
<span><span class="co">#&gt; --  466  samples  did not fit previous datasets</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">end_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">time_</span> <span class="op">=</span> <span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">time_</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Time difference of 1.236569 hours</span></span></code></pre>
<p>We plot the sample as a two dimensional histogram plot-matrix using
the hexbin package:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span><span class="co">#</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HISKP-LQCD/hadron" class="external-link">hadron</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">ac</span> <span class="op">&lt;-</span> <span class="fu">hadron</span><span class="fu">::</span><span class="fu">uwerr</span><span class="op">(</span>data<span class="op">=</span><span class="va">mcmc</span><span class="op">$</span><span class="va">scores</span>,pl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">ac</span><span class="op">$</span><span class="va">tauint</span><span class="op">+</span><span class="va">ac</span><span class="op">$</span><span class="va">dtauint</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span>,by<span class="op">=</span><span class="va">tau</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="AKAR4_files/figure-html/sample-density-1.png" width="1200"><img src="AKAR4_files/figure-html/sample-density-2.png" width="1200"><img src="AKAR4_files/figure-html/sample-density-3.png" width="1200"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/hexbin" class="external-link">hexbin</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">hexbin</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/hexbin/man/hexplom.html" class="external-link">hexplom</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,xbins<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="AKAR4_files/figure-html/sample-density-4.png" width="1200"></p>
<p>A sensitivity plot using the results of the above loop:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]    1  225 2034</span></span></code></pre></div>
<p>where <code>y[[1]]</code> refers to the simulation corresponding to
the first experiment: <code>experiment[[1]]</code>, and
<code>$func</code> refers to the output function values (rather than
state variables). The outout functions are defined in the table
<code>SBtab$Output</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="fl">1</span>,,<span class="op">]</span><span class="op">)</span> <span class="co"># aperm makes the sample-index (3rd) the first index of f, default permutation</span></span>
<span><span class="va">S</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/globalSensitivity.html">globalSensitivity</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">draws</span>,<span class="va">f</span><span class="op">)</span></span>
<span><span class="va">S</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co"># the first index of S is time, and initially sensitivity is 0</span></span>
<span><span class="va">cuS</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">S</span>,<span class="fl">1</span>,<span class="va">cumsum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/frame.html" class="external-link">plot.new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tm</span><span class="op">&lt;-</span><span class="va">experiments</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">cuS</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"time"</span>,ylab<span class="op">=</span><span class="st">"S"</span>,main<span class="op">=</span><span class="st">"sensitivity (cumulative)"</span><span class="op">)</span></span>
<span><span class="co">## this section makes a little sensitivity plot:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">si</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tm</span>,<span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cuS</span><span class="op">[</span>,<span class="va">si</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,col<span class="op">=</span><span class="va">si</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="AKAR4_files/figure-html/plot-1.png" width="700"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
