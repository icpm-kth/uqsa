<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Parallel chains with MPI • uqsa</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallel chains with MPI">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/install.html">Full Installation Instructions</a>
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/uq.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/sa.html">Sensiticity Analysis</a>
    <h6 class="dropdown-header" data-toc-skip>Model and data management</h6>
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing a model</a>
    <a class="dropdown-item" href="../articles/data.html">Importing data</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/user_model.html">Build your own Model</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Paremeter estimation and uncertainty quantification</h6>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a>
    <a class="dropdown-item" href="../articles/ABC_sampling.html">ABC sampling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sensitivity analysis</h6>
    <a class="dropdown-item" href="../articles/GSA.html">GSA following UQ</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <a class="dropdown-item" href="../articles/simAKAP79.html">Simulate AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAP79.html">sample AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAR4.html">sample AKAR4 with ABC</a>
    <a class="dropdown-item" href="../articles/AKAR4cl.html">sample AKAR4 with MCMC</a>
    <a class="dropdown-item" href="../articles/shortMakeSharedLibrary.html">Build a Model</a>
    <a class="dropdown-item" href="../articles/mpi.html">Multiple chains via MPI</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="mpi_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Parallel chains with MPI</h1>
            
      
      
      <div class="d-none name"><code>mpi.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>Markov chain Monte Carlo scales exponentially with the problem size. For models with ~50 parameters it already becomes hard to intialize a Markov chain with good values: - starting parameters - step size</p>
<p>The effect is a slow moving chain, and a sample with high auto-correlation.</p>
<p>To reduce auto-correlation, we suggest the parallel tempering technique, where several Markov chains run in parallel and each experiences a different likelihood: <span class="math inline">\(p(D|\theta)^\beta\)</span> where <span class="math inline">\(\theta\)</span> is the Markov chain variable (maps to the model’s kinetic parameters) and <span class="math inline">\(D\)</span> is the available data. In this context <span class="math inline">\(0 \le \beta \le 1\)</span> plays the role of an inverse temperature. A value of <span class="math inline">\(\beta = 1.0\)</span> is equivalent to the original problem; the lower <span class="math inline">\(\beta\)</span> gets, the more does the target distribution resemble the prior distribution.</p>
<p>The different chains are then allowed to exchange their positions if it is benefitial (according to the specific rules of parallel tempering). This exchange of information makes the chain with <span class="math inline">\(\beta = 1\)</span> explore the sampling space much faster than the Markov chain algorithm by itself would allow.</p>
<p>Even though the implementation of Parallel Tempering is possible without MPI, we now have several experiments to simulate on many parallel chains, for AKAP79 this is 20 experiments and e.g. 32 chains. At this point, it becomes benefitial to do the simulations on more than one machine (mine has 16 cores). The <em>high performance computing</em> cluster at KTH (Parallel Dator Center, Dardel cluster) has 128 cores per node. This means that we can simulate 6 chains per node and still process all experiments at the same time (using <code>parLapply</code>), but also start 24 chains distributed accross 3 nodes.</p>
<p>The distribution requires message passing between nodes, for this prupose we use <a href="https://cran.r-project.org/package=Rmpi" class="external-link">Rmpi</a>.</p>
<p>MPI code is difficult to understand, write, test, and debug. So, the below instructions may not work for everyone.</p>
</div>
<div class="section level2">
<h2 id="akap79">AKAP79<a class="anchor" aria-label="anchor" href="#akap79"></a>
</h2>
<p>MPI has several mechanisms to launch worker processes, one ow which is the <code>spawn</code> method (<code>MPI_Comm_spawn</code>). We don’t use this here.</p>
<p>Instead we launch an Rscript via <code>mpirun</code> (and we use the <code>send</code> and <code>recv</code> functions on <code>MPI_COMM_WORLD</code>, which corresponds to <code>comm=0</code> in Rmpi). The script is written with MPI in mind and assumes that it runs in parallel, every command listed below will execute on every worker. This is different from the <code>parLapply</code> paradigm, where work is dispatched to worker threads (or processes).</p>
<p>The only difference between the workers is the <code>rank</code>. The rank will determine the value of <span class="math inline">\(\beta\)</span> and thus the kind of sample the worker obtains.</p>
<p>The <code>mpirun</code> command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">mpirun</span> -H localhost:16 -N 8 ./AKAP79.R 5000</span></code></pre></div>
<p>where <code>5000</code> is the sample size and <code>-N 8</code> means that we launch 8 MPI workers per node, and here we have one node (host), with 16 slots to run workers in. On a cluster, we can increase these numbers (and there is no need for <code>-H</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/bin/env Rscript</span></span>
<span></span>
<span><span class="co">## ----setup--------------------------------------------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgsl</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fisher.stats.uwo.ca/faculty/yu/Rmpi/" class="external-link">Rmpi</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>                         <span class="co"># measure sampling time</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rmpi/man/mpi.comm.html" class="external-link">mpi.comm.rank</a></span><span class="op">(</span>comm<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rmpi/man/mpi.comm.html" class="external-link">mpi.comm.size</a></span><span class="op">(</span>comm<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="op">(</span><span class="va">r</span><span class="op">/</span><span class="va">cs</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">4</span></span>
<span><span class="va">nChains</span> <span class="op">&lt;-</span> <span class="va">cs</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">300</span> <span class="co"># default</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## ----label="SBtab content"----------------------------------------------------</span></span>
<span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,pattern<span class="op">=</span><span class="st">"[.]tsv$"</span>,full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----model--------------------------------------------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,pat<span class="op">=</span><span class="st">"^AKAP79[.]R$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,<span class="st">"./AKAP79.so"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----ConservationLaws---------------------------------------------------------</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAP79"</span>,pat<span class="op">=</span><span class="st">"^ConservationLaws[.]RData$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">experiments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">SBtab</span>,<span class="va">ConLaw</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## ----default------------------------------------------------------------------</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">n</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">parVal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">AKAP79_default</span><span class="op">(</span><span class="op">)</span>,<span class="op">-</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----range--------------------------------------------------------------------</span></span>
<span><span class="va">defRange</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># log-10 space</span></span>
<span><span class="va">dprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dNormalPrior.html">dNormalPrior</a></span><span class="op">(</span>mean<span class="op">=</span><span class="va">parVal</span>,sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">defRange</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rNormalPrior.html">rNormalPrior</a></span><span class="op">(</span>mean<span class="op">=</span><span class="va">parVal</span>,sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">defRange</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----simulate-----------------------------------------------------------------</span></span>
<span><span class="va">sensApprox</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sensitivityEquilibriumApproximation.html">sensitivityEquilibriumApproximation</a></span><span class="op">(</span><span class="va">experiments</span>, <span class="va">model</span>, <span class="va">log10ParMap</span>, <span class="va">log10ParMapJac</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">simulate</span> <span class="op">&lt;-</span> <span class="fu">simulate.c</span><span class="op">(</span><span class="va">experiments</span>,<span class="va">modelName</span>,<span class="va">log10ParMap</span>,noise<span class="op">=</span><span class="cn">FALSE</span>,sensApprox<span class="op">=</span><span class="va">sensApprox</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----likelihood---------------------------------------------------------------</span></span>
<span><span class="va">llf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logLikelihood.html">logLikelihood</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">)</span></span>
<span><span class="va">gradLL</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gradLogLikelihood.html">gradLogLikelihood</a></span><span class="op">(</span><span class="va">model</span>,<span class="va">experiments</span>, parMap<span class="op">=</span><span class="va">log10ParMap</span>, parMapJac<span class="op">=</span><span class="va">log10ParMapJac</span><span class="op">)</span></span>
<span><span class="va">fiIn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fisherInformation.html">fisherInformation</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">experiments</span>, parMap<span class="op">=</span><span class="va">log10ParMap</span><span class="op">)</span></span>
<span><span class="va">fiPrior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">defRange</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ----update-------------------------------------------------------------------</span></span>
<span><span class="va">update</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcUpdate.html">mcmcUpdate</a></span><span class="op">(</span>simulate<span class="op">=</span><span class="va">simulate</span>,</span>
<span>                  experiments<span class="op">=</span><span class="va">experiments</span>,</span>
<span>                  model<span class="op">=</span><span class="va">model</span>,</span>
<span>                  logLikelihood<span class="op">=</span><span class="va">llf</span>,</span>
<span>                  gradLogLikelihood<span class="op">=</span><span class="va">gradLL</span>,</span>
<span>                  fisherInformation<span class="op">=</span><span class="va">fiIn</span>,</span>
<span>                  fisherInformationPrior<span class="op">=</span><span class="va">fiPrior</span>,</span>
<span>                  dprior<span class="op">=</span><span class="va">dprior</span><span class="op">)</span></span>
<span><span class="co">## ----init---------------------------------------------------------------------</span></span>
<span><span class="co">#m &lt;- mcmc(update)              # a serial Markov chain Monte Carlo function</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc_mpi.html">mcmc_mpi</a></span><span class="op">(</span><span class="va">update</span>,comm<span class="op">=</span><span class="fl">0</span><span class="op">)</span>    <span class="co"># MPI aware function, passes messages on "comm"</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">1e-3</span>                       <span class="co"># initial step size guess</span></span>
<span><span class="co">## ----adjust-------------------------------------------------------------------</span></span>
<span><span class="va">accTarget</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">a</span><span class="op">-</span><span class="va">accTarget</span><span class="op">)</span><span class="op">/</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">}</span></span>
<span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">parVal</span></span>
<span><span class="va">nj</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="va">initFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"rmpi-init-rank-%i-of-%i.RData"</span>,<span class="va">r</span>,<span class="va">cs</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">initFile</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">initFile</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">nj</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcInit.html">mcmcInit</a></span><span class="op">(</span><span class="va">beta</span>,<span class="va">x</span>,<span class="va">simulate</span>,<span class="va">dprior</span>,<span class="va">llf</span>,<span class="va">gradLL</span>,<span class="va">fiIn</span><span class="op">)</span></span>
<span>        <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu">m</span><span class="op">(</span><span class="va">x</span>,<span class="fl">100</span>,eps<span class="op">=</span><span class="va">h</span><span class="op">)</span></span>
<span>        <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="st">"acceptanceRate"</span><span class="op">)</span></span>
<span>        <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">h</span> <span class="op">*</span> <span class="fu">L</span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span>        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="st">"lastPoint"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"iteration %02i/%02i for rank %02i/%02i,\th = %g\n"</span>,<span class="va">j</span>,<span class="va">nj</span>,<span class="va">r</span>,<span class="va">cs</span>,<span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">h</span>,<span class="va">beta</span>,file<span class="op">=</span><span class="va">initFile</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"final step size: "</span>,<span class="va">h</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"finished adjusting after"</span>,<span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">start_time</span>,units<span class="op">=</span><span class="st">"sec"</span><span class="op">)</span>,<span class="st">" seconds\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">## ----sample-------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">m</span><span class="op">(</span><span class="va">x</span>,<span class="va">N</span>,<span class="va">h</span><span class="op">)</span> <span class="co"># the main amount of work is done here</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">s</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Rmpi-testSample-rank%i-of%i.RData"</span>,<span class="va">r</span>,<span class="va">cs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">start_time</span>,units<span class="op">=</span><span class="st">"sec"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rmpi/man/mpi.finalize.html" class="external-link">mpi.finalize</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">time_</span><span class="op">)</span></span></code></pre></div>
<p>In this script these is an <em>adjust</em> phase where we find an appropriate step size for the given problem. This is done by trying to make the Markov chain acceptance rate roughly <code>1/4</code>, which seems to be a good enough value to reduce the auto-correlation within the resulting sample (it is further decreased through parallel tempering).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
