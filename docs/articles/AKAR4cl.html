<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>AKAR4 with MCMC • uqsa</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="AKAR4 with MCMC">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/install.html">Full Installation Instructions</a>
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/uq.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/sa.html">Sensiticity Analysis</a>
    <h6 class="dropdown-header" data-toc-skip>Model and data management</h6>
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing a model</a>
    <a class="dropdown-item" href="../articles/data.html">Importing data</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/user_model.html">Build your own Model</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Paremeter estimation and uncertainty quantification</h6>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a>
    <a class="dropdown-item" href="../articles/ABC_sampling.html">ABC sampling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sensitivity analysis</h6>
    <a class="dropdown-item" href="../articles/GSA.html">GSA following UQ</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <a class="dropdown-item" href="../articles/simAKAP79.html">Simulate AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAP79.html">sample AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAR4.html">sample AKAR4 with ABC</a>
    <a class="dropdown-item" href="../articles/AKAR4cl.html">sample AKAR4 with MCMC</a>
    <a class="dropdown-item" href="../articles/shortMakeSharedLibrary.html">Build a Model</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="AKAR4cl_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>AKAR4 with MCMC</h1>
            
      
      
      <div class="d-none name"><code>AKAR4cl.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgsl</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/hexbin" class="external-link">hexbin</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="akar4-with-conservation-law-analysis">AKAR4 with Conservation Law Analysis<a class="anchor" aria-label="anchor" href="#akar4-with-conservation-law-analysis"></a>
</h2>
<p>This is a version of the AKAR4 model that was built with conservation law analysis turned on when processing the SBtab content to produce the vector field file (<code>vf</code>). This has a downstream effect on the R and C code.</p>
<div class="section level3">
<h3 id="loading-model-and-data">Loading Model and Data<a class="anchor" aria-label="anchor" href="#loading-model-and-data"></a>
</h3>
<p>We load the SBtab content from the tsv files to extract the data from it:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,pattern<span class="op">=</span><span class="st">"[.]tsv$"</span>,full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span>
<span><span class="co">#&gt; [tsv] file[1] «/home/andrei/R/library/uqsa/extdata/AKAR4cl/100nM.tsv» belongs to Document «AKAR4cl»</span></span>
<span><span class="co">#&gt;  I'll take this as the Model Name.</span></span></code></pre></div>
<p>The next block will load a series of functions: <code>AKAR4cl_vf</code>, <code>AKAR4cl_jac</code>, etc.; it also loads the <code>model</code> variable: a list of the same functions with generic names.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,pat<span class="op">=</span><span class="st">"^AKAR4cl[.]R$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "vf"       "jac"      "jacp"     "func"     "funcJac"  "funcJacp" "init"    </span></span>
<span><span class="co">#&gt; [8] "par"      "name"</span></span>
<span><span class="co"># compile</span></span>
<span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,<span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,pat<span class="op">=</span><span class="st">"_gvf[.]c$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; building a shared library from c source, and using GSL odeiv2 as backend (pkg-config is used here).</span></span>
<span><span class="co">#&gt; cc -shared -fPIC `pkg-config --cflags gsl` -o './AKAR4cl.so' '/home/andrei/R/library/uqsa/extdata/AKAR4cl/AKAR4cl_gvf.c' `pkg-config --libs gsl`</span></span></code></pre></div>
<div class="section level4">
<h4 id="data-and-experiments">Data and Experiments<a class="anchor" aria-label="anchor" href="#data-and-experiments"></a>
</h4>
<p>The <code>experiments</code> variable contains a description of how to simulate an experiment but also the data that this simulation should try replicate. Since the model was build with conservation law analysis, we need to load the results of this analysis, to adjust the simulation instructions:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,pat<span class="op">=</span><span class="st">"^ConservationLaws[.]RData$"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ConLaw</span><span class="op">$</span><span class="va">Text</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AKAR4_C_ConservedConst = AKAR4_C+1*C"     </span></span>
<span><span class="co">#&gt; [2] "AKAR4_ConservedConst = AKAR4+1*AKAR4p-1*C"</span></span>
<span><span class="va">experiments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">SBtab</span>,<span class="va">ConLaw</span><span class="op">)</span></span></code></pre></div>
<p>The default values for the ODE model parameters, taking the new inputs into account:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">n</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">parVal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">AKAR4cl_default</span><span class="op">(</span><span class="op">)</span>,<span class="op">-</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span><span class="co">#&gt; kf_C_AKAR4 kb_C_AKAR4 kcat_AKARp </span></span>
<span><span class="co">#&gt;      0.018      0.106     10.200</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="prior">Prior<a class="anchor" aria-label="anchor" href="#prior"></a>
</h3>
<p>Scale to determine prior values, a default parameter range:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">defRange</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># log-10 space</span></span>
<span><span class="va">dprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dNormalPrior.html">dNormalPrior</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span>,sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">defRange</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rNormalPrior.html">rNormalPrior</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span>,sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">defRange</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">dprior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.007936704</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mcmc-related-model-functions">MCMC related Model Functions<a class="anchor" aria-label="anchor" href="#mcmc-related-model-functions"></a>
</h3>
<p>Here we construct several closures needed for MCMC</p>
<div class="section level4">
<h4 id="simulations">Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sensApprox</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sensitivityEquilibriumApproximation.html">sensitivityEquilibriumApproximation</a></span><span class="op">(</span><span class="va">experiments</span>, <span class="va">model</span>, <span class="va">log10ParMap</span>, <span class="va">log10ParMapJac</span><span class="op">)</span></span>
<span><span class="va">simulate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">experiments</span>,<span class="va">modelName</span>,<span class="va">log10ParMap</span>,noise<span class="op">=</span><span class="cn">FALSE</span>,<span class="va">sensApprox</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">'time'</span>,ylab<span class="op">=</span><span class="st">'AKAR4p'</span>, main<span class="op">=</span><span class="st">'state'</span>,type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="AKAR4cl_files/figure-html/simulate-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="likelihood-related-functions">Likelihood related Functions<a class="anchor" aria-label="anchor" href="#likelihood-related-functions"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">llf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logLikelihood.html">logLikelihood</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">)</span></span>
<span><span class="va">gradLL</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gradLogLikelihood.html">gradLogLikelihood</a></span><span class="op">(</span><span class="va">model</span>,<span class="va">experiments</span>, parMap<span class="op">=</span><span class="va">log10ParMap</span>, parMapJac<span class="op">=</span><span class="va">log10ParMapJac</span><span class="op">)</span></span>
<span><span class="va">fiIn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fisherInformation.html">fisherInformation</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">experiments</span>, parMap<span class="op">=</span><span class="va">log10ParMap</span><span class="op">)</span></span>
<span><span class="va">fiPrior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">defRange</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fiPrior</span><span class="op">)</span> <span class="co"># constant matrix</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]  0.5  0.0  0.0</span></span>
<span><span class="co">#&gt; [2,]  0.0  0.5  0.0</span></span>
<span><span class="co">#&gt; [3,]  0.0  0.0  0.5</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="maerkov-chain-update-function">Maerkov Chain Update Function<a class="anchor" aria-label="anchor" href="#maerkov-chain-update-function"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">update</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcUpdate.html">mcmcUpdate</a></span><span class="op">(</span>simulate<span class="op">=</span><span class="va">simulate</span>,</span>
<span>    experiments<span class="op">=</span><span class="va">experiments</span>,</span>
<span>    model<span class="op">=</span><span class="va">model</span>,</span>
<span>    logLikelihood<span class="op">=</span><span class="va">llf</span>,</span>
<span>    gradLogLikelihood<span class="op">=</span><span class="va">gradLL</span>,</span>
<span>    fisherInformation<span class="op">=</span><span class="va">fiIn</span>,</span>
<span>    fisherInformationPrior<span class="op">=</span><span class="va">fiPrior</span>,</span>
<span>    dprior<span class="op">=</span><span class="va">dprior</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="find-a-good-smmala-step-size">Find a Good SMMALA step size:<a class="anchor" aria-label="anchor" href="#find-a-good-smmala-step-size"></a>
</h3>
<p>Here, we construct an <code>mcmc</code> function derived from the update function, initialize the Markov chain and start several chains in parallel:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmc.html">mcmc</a></span><span class="op">(</span><span class="va">update</span><span class="op">)</span>   <span class="co"># a Markov chain</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">1e-1</span>           <span class="co"># step size guess</span></span>
<span></span>
<span><span class="va">nChains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span></code></pre></div>
<p>We define an adjustment factor <code>L(a)</code> for <code>h</code>, based on the acceptance rate <code>a</code> of a test chain of size <code>N</code> (a good value for a test chain is around 100). The factor <code>L(a)</code> increases <code>h</code> if <code>a</code> is above the target acceptance of 25%.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accTarget</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">a</span><span class="op">-</span><span class="va">accTarget</span><span class="op">)</span><span class="op">/</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">}</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span>                              <span class="co"># do the adjustment of h a few times</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"adjusting step size: "</span>,<span class="va">h</span>,<span class="st">" \n"</span><span class="op">)</span>;</span>
<span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcmcInit.html">mcmcInit</a></span><span class="op">(</span><span class="fl">1.0</span>,<span class="va">x</span>,<span class="va">simulate</span>,<span class="va">dprior</span>,<span class="va">llf</span>,<span class="va">gradLL</span>,<span class="va">fiIn</span><span class="op">)</span></span>
<span> <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu">m</span><span class="op">(</span><span class="va">x</span>,<span class="va">N</span>,eps<span class="op">=</span><span class="va">h</span><span class="op">)</span></span>
<span> <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="st">"acceptanceRate"</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"acceptance: "</span>,<span class="va">a</span><span class="op">*</span><span class="fl">100</span>,<span class="st">" %\n"</span><span class="op">)</span></span>
<span> <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">h</span> <span class="op">*</span> <span class="fu">L</span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; adjusting step size:  0.1  </span></span>
<span><span class="co">#&gt; acceptance:  27  %</span></span>
<span><span class="co">#&gt; adjusting step size:  0.1049834  </span></span>
<span><span class="co">#&gt; acceptance:  29  %</span></span>
<span><span class="co">#&gt; adjusting step size:  0.115344  </span></span>
<span><span class="co">#&gt; acceptance:  18  %</span></span>
<span><span class="co">#&gt; adjusting step size:  0.09594452  </span></span>
<span><span class="co">#&gt; acceptance:  28  %</span></span>
<span><span class="co">#&gt; adjusting step size:  0.1030869  </span></span>
<span><span class="co">#&gt; acceptance:  19  %</span></span>
<span><span class="co">#&gt; adjusting step size:  0.08807162  </span></span>
<span><span class="co">#&gt; acceptance:  29  %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="st">"logLikelihood"</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"iteration"</span>,ylab<span class="op">=</span><span class="st">"log-likelihood"</span>,main<span class="op">=</span><span class="st">"small Sample to find a good step size"</span>,type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="AKAR4cl_files/figure-html/adjust-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"final step size: "</span>,<span class="va">h</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; final step size:  0.0967632</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"finished adjusting after"</span>,<span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">start_time</span>,units<span class="op">=</span><span class="st">"sec"</span><span class="op">)</span>,<span class="st">" seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; finished adjusting after 30.12104  seconds</span></span></code></pre></div>
<p>Initialize parallel execution, with 4 processes, but 16 Markov chains.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">16</span>                                          <span class="co"># cluster size</span></span>
<span><span class="va">nChains</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeForkCluster</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">clusterSetRNGStream</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1337</span><span class="op">)</span>          <span class="co"># seeding random numbers sequences</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,length.out<span class="op">=</span><span class="va">nChains</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">parMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">betas</span>,<span class="va">mcmcInit</span>,parMCMC<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span>,simulate<span class="op">=</span><span class="va">simulate</span>,dprior<span class="op">=</span><span class="va">dprior</span>,logLikelihood<span class="op">=</span><span class="va">llf</span>,gradLogLikelihood<span class="op">=</span><span class="va">gradLL</span>,fisherInformation<span class="op">=</span><span class="va">fiIn</span><span class="op">)</span></span></code></pre></div>
<p>Next, we perform the sampling in parallel, but also swap positions every once in a while:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>                         <span class="co"># measure sampling time</span></span>
<span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>                            <span class="co"># 16 chains, 4 workers</span></span>
<span> <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">parMCMC</span>, <span class="va">m</span>, N<span class="op">=</span><span class="fl">100</span>, eps<span class="op">=</span><span class="va">h</span><span class="op">)</span></span>
<span> <span class="va">parMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">s</span>,<span class="va">attr</span>,which<span class="op">=</span><span class="st">"lastPoint"</span><span class="op">)</span></span>
<span> <span class="va">parMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/swap_points.html">swap_points</a></span><span class="op">(</span><span class="va">parMCMC</span><span class="op">)</span></span>
<span> <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">&gt;</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span> <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parVal</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">time_</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">start_time</span>,units<span class="op">=</span><span class="st">"sec"</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"finished sampling after"</span>,<span class="va">time_</span>,<span class="st">" seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; finished sampling after 650.7688  seconds</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>The final sample looks like this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">Sample</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          kf_C_AKAR4 kb_C_AKAR4 kcat_AKARp</span></span>
<span><span class="co">#&gt; [39991,]  -1.748616  -1.226415   2.167335</span></span>
<span><span class="co">#&gt; [39992,]  -1.748616  -1.226415   2.167335</span></span>
<span><span class="co">#&gt; [39993,]  -1.748616  -1.226415   2.167335</span></span>
<span><span class="co">#&gt; [39994,]  -1.748616  -1.226415   2.167335</span></span>
<span><span class="co">#&gt; [39995,]  -1.728994  -1.217590   2.261970</span></span>
<span><span class="co">#&gt; [39996,]  -1.745386  -1.282003   2.287830</span></span>
<span><span class="co">#&gt; [39997,]  -1.745386  -1.282003   2.287830</span></span>
<span><span class="co">#&gt; [39998,]  -1.745386  -1.282003   2.287830</span></span>
<span><span class="co">#&gt; [39999,]  -1.745386  -1.282003   2.287830</span></span>
<span><span class="co">#&gt; [40000,]  -1.745386  -1.282003   2.287830</span></span>
<span><span class="fu">hexbin</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/hexbin/man/hexplom.html" class="external-link">hexplom</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">)</span></span></code></pre></div>
<p><img src="AKAR4cl_files/figure-html/hexplom-1.png" width="1152"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
