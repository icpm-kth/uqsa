<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Build and simulate your own Model • uqsa</title>
<script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Build and simulate your own Model">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="file:///usr/share/javascript/mathjax/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
    <a class="dropdown-item" href="../articles/installExplanations.html">Explanation for System Prerequisites</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing Models</a>
    <a class="dropdown-item" href="../articles/data.html">Importing Data</a>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/UQ.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/GSA.html">Global Sensitivity Analysis</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/more_details.html">More details...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAR4</h6>
    <a class="dropdown-item" href="../articles/simAKAR4.html">Simulate deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/simAKAR4stochastic.html">Simulate stochastic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4.html">UQ on deterministic AKAR4</a>
    <a class="dropdown-item" href="../articles/sampleAKAR4stochastic.html">UQ on stochasic AKAR4</a>
    <a class="dropdown-item" href="../articles/GSA_AKAR4.html">GSA on AKAR4</a>
    <a class="dropdown-item" href="../articles/uqsaAKAR4.html">UQ and SA on AKAR4</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>AKAP79</h6>
    <a class="dropdown-item" href="../articles/sampleAKAP79.html">UQ on deterministic AKAP79</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>CaMKII</h6>
    <a class="dropdown-item" href="../articles/smmala.html">Calibrate CaMKII with SMMALA</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Extra</h6>
    <a class="dropdown-item" href="../articles/extraExamples.html">More examples...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Build and simulate your own Model</h1>
            
      
      
      <div class="d-none name"><code>user_model.Rmd</code></div>
    </div>

    
    
<p>In this article we will assume that you have a reaction network model
that you want to work on and that you have written the model in the
SBtab format. It may be a Google spreadsheet, an open document
spreadsheet (<code>.ods</code>), an MS Excel file, a file for the
“Numbers” application on an Apple device or a <code>.gnumeric</code>
file.</p>
<p>Firstly, you need to <em>build</em> your model, i.e., translate your
reaction network model from the SBtab format into machine code that can
be used for simulations in UQSA.</p>
<div class="section level3">
<h3 id="build-your-model">Build your model<a class="anchor" aria-label="anchor" href="#build-your-model"></a>
</h3>
<p>There are three steps we need to make to build the model:</p>
<table class="table">
<colgroup>
<col width="4%">
<col width="48%">
<col width="16%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th align="right"></th>
<th align="left">Steps</th>
<th align="center">file (out)</th>
<th align="center">tl;dr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">convert SBtab to ODE</td>
<td align="center">[optional]</td>
<td align="center">biology =&gt; math</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">convert the ODE to C code</td>
<td align="center">.c</td>
<td align="center">math =&gt; code</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">convert C code to shared library</td>
<td align="center">.so</td>
<td align="center">code =&gt; machine code</td>
</tr>
</tbody>
</table>
<hr>
<p>The <em>optional</em> file formats for ODEs are .vf, .mod, .ode, and
plain text (.txt).</p>
<p>We generate C code in R for the SBtab model using the computer
algebra package <a href="https://cran.r-project.org/package=Ryacas" class="external-link">Ryacas</a>, which
interfaces between R and <a href="http://www.yacas.org/" class="external-link">yacas</a> –
both need to be installed.</p>
<p>These three steps can be performed with the R commands below. <a href="https://github.com/icpm-kth/SBtabVFGEN" class="external-link">SBtabVFGEN</a> refers to
our external package.</p>
<div class="section level5">
<h5 id="convert-sbtab-to-ode">Convert SBtab to ODE<a class="anchor" aria-label="anchor" href="#convert-sbtab-to-ode"></a>
</h5>
<p>The following two commands are unrelated to code generation. They
just find and load the biological model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/uqsa_example.html">uqsa_example</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span><span class="op">)</span>    <span class="co"># paths to the TSV files</span></span>
<span><span class="va">sb</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>   <span class="co"># loads the TSV files</span></span></code></pre></div>
<p>We convert the model into an ordinary differential equation (and
create intermediate files, various formats).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">odeModel</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_to_vfgen.html" class="external-link">sbtab_to_vfgen</a></span><span class="op">(</span><span class="va">sb</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="convert-the-ode-to-c-code">Convert the ODE to C code<a class="anchor" aria-label="anchor" href="#convert-the-ode-to-c-code"></a>
</h5>
<p>The function <code>generateCode</code> below accepts the return value
of <code><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_to_vfgen.html" class="external-link">SBtabVFGEN::sbtab_to_vfgen()</a></code> (a list of ode properties)
and returns a character vector of C code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/generateCode.html">generateCode</a></span><span class="op">(</span><span class="va">odeModel</span><span class="op">)</span></span></code></pre></div>
<p>This returns the generated code as a character vector, it can be
viewed (and written to a file) using the <code>cat</code> function.</p>
<p>The print the first few lines of the generated code (25 lines in the
example), you can run the following command. You can use the
<code>file=</code> argument of <code>cat</code> to print it into a
file.:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">C</span>,<span class="fl">25</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>The following command saves the C source code in the file
“AKAR4cl_gvf.c”.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">C</span>, sep <span class="op">=</span> <span class="st">"\n"</span>, file <span class="op">=</span> <span class="st">"AKAR4cl_gvf.c"</span><span class="op">)</span></span></code></pre></div>
<p>The file just created contains the following functions:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">grep</span> AKAR4cl_ ./AKAR4cl_gvf.c</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_vf(double t, const double y_[], double *f_, void *par){</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_jac(double t, const double y_[], double *jac_, double *dfdt_, void *par){</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_jacp(double t, const double y_[], double *jacp_, double *dfdt_, void *par){</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_func(double t, const double y_[], double *func_, void *par){</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_funcJac(double t, const double y_[], double *funcJac_, void *par){</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_funcJacp(double t, const double y_[], double *funcJacp_, void *par){</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_default(double t, double *p_){</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; int AKAR4cl_init(double t, double *y_, void *par){</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="convert-c-code-to-shared-library">Convert C code to shared library<a class="anchor" aria-label="anchor" href="#convert-c-code-to-shared-library"></a>
</h5>
<p>The following command compiles the model (if not yet compiled).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"AKAR4cl"</span>,<span class="st">"AKAR4cl_gvf.c"</span><span class="op">)</span></span>
<span><span class="co">#&gt; building a shared library from c source, and using GSL odeiv2 as backend (pkg-config is used here).</span></span>
<span><span class="co">#&gt; cc -shared -fPIC `pkg-config --cflags gsl` -o './AKAR4cl.so' 'AKAR4cl_gvf.c' `pkg-config --libs gsl`</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="optional-generate-code-for-desolve-ode-solver-in-r">(Optional) Generate code for deSolve (ODE solver in R):<a class="anchor" aria-label="anchor" href="#optional-generate-code-for-desolve-ode-solver-in-r"></a>
</h5>
<p>It is also possible to create R code, intended for use with <a href="https://cran.r-project.org/package=deSolve" class="external-link">deSolve</a>. Combining
all previous function calls into one (writing to file immediately).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/comment.html" class="external-link">comment</a></span><span class="op">(</span><span class="va">odeModel</span><span class="op">)</span>,<span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/generateRCode.html">generateRCode</a></span><span class="op">(</span><span class="va">odeModel</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"\n"</span>,file<span class="op">=</span><span class="va">rFile</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="va">rFile</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># example call:</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">AKAR4cl_default</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span></span>
<span><span class="va">y0</span> <span class="op">&lt;-</span> <span class="fu">AKAR4cl_init</span><span class="op">(</span><span class="fl">0.0</span>,<span class="va">p</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">y0</span><span class="op">)</span></span>
<span><span class="co">#&gt; AKAR4p      C </span></span>
<span><span class="co">#&gt;      0      0</span></span></code></pre></div>
<p>A test-simulation with deSolve:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="http://desolve.r-forge.r-project.org/" class="external-link">deSolve</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">t_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span>,length.out<span class="op">=</span><span class="fl">128</span><span class="op">)</span></span>
<span>    <span class="va">y_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/deSolve/man/ode.html" class="external-link">ode</a></span><span class="op">(</span><span class="va">y0</span>,<span class="va">t_</span>,<span class="va">AKAR4cl_vf</span>,<span class="va">p</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">t_</span>,<span class="va">y_</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,type<span class="op">=</span><span class="st">'l'</span>,main<span class="op">=</span><span class="st">"AKAR4cl"</span>,xlab<span class="op">=</span><span class="st">"time"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading required package: deSolve</span></span></code></pre></div>
<p><img src="user_model_files/figure-html/simulation-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulate">Simulate<a class="anchor" aria-label="anchor" href="#simulate"></a>
</h2>
<p>We now show how to simulate the model the same conditions as in the
experiments (e.g., same initial conditions). More details on simulating
the model can be found in the page <a href="simulate.html">“Simulating a
model”</a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import the experimental data</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">sb</span>,<span class="va">odeModel</span><span class="op">$</span><span class="va">conservationLaws</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we create a closure called "sim" a function that internally remembers the "experiments" (ex)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">ex</span>,<span class="va">modelName</span><span class="op">)</span>                   <span class="co"># ex holds the instructions for the solver</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">sb</span><span class="op">$</span><span class="va">Parameter</span><span class="op">[[</span><span class="st">"!DefaultValue"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>  <span class="co"># one column - but can be several sets (as columns)</span></span>
<span></span>
<span><span class="co">## sim can be called with any parameter vector - or several and will always simulate the same set of experiments</span></span>
<span><span class="va">sr</span> <span class="op">&lt;-</span> <span class="fu">sim</span><span class="op">(</span><span class="va">par</span><span class="op">)</span>                                     <span class="co"># simulation results (one per experiment)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sr</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputValues</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="va">dy</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">errorValues</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">sr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="fl">1</span>,<span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>                           <span class="co"># third dimension is the par column (just one here)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">z</span>,bty<span class="op">=</span><span class="st">'n'</span>,type<span class="op">=</span><span class="st">'l'</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">90</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html" class="external-link">arrows</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,<span class="va">t</span>,<span class="va">y</span><span class="op">+</span><span class="va">dy</span>,angle<span class="op">=</span><span class="fl">90</span>, length<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html" class="external-link">arrows</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,<span class="va">t</span>,<span class="va">y</span><span class="op">-</span><span class="va">dy</span>,angle<span class="op">=</span><span class="fl">90</span>, length<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simulation"</span>,<span class="st">"data"</span><span class="op">)</span>, lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, pch<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="user_model_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The simulation result <code>sr</code> is a list with several
components, including:</p>
<ul>
<li>
<code>state</code>, state variable trajectories</li>
<li>
<code>func</code>, output functions</li>
</ul>
<p>The output functions usually correspond to the data (in some way),
but may need some sort of normalization. In this example, the
relationship is direct.</p>
<p>Both <code>state</code> and <code>func</code> have three indices:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sr</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span>        <span class="co"># is a number</span></span></code></pre></div>
<p>This corresponds to experiment <code>l</code>, state variable
<code>i</code>, time-point <code>j</code>, and parameter column
<code>k</code> (relevant when <code>par</code> is a matrix with multiple
columns).</p>
<hr>
<p>The previously created <code>modelName</code> variable has a comment
attribute (that you can also set yourself, there is no magic there).
This attribute indicates the location of the shared library used for
simulations. With this, ytou don’t have to re-make it every time - as
long as the model doesn’t change (i.e., <code>checkModel</code> does not
need to be re-called):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/comment.html" class="external-link">comment</a></span><span class="op">(</span><span class="va">modelName</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"./AKAR4cl.so"</span> <span class="co"># this is sufficient if the .so file already exists</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulations-of-several-parameter-sets">Simulations of Several Parameter Sets<a class="anchor" aria-label="anchor" href="#simulations-of-several-parameter-sets"></a>
</h2>
<p>The following commands allow you to simulate multiple parameters
(saved in the matrix <code>P</code>) at the same time.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ex</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span><span class="op">)</span></span>
<span><span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span><span class="va">REPS</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">np</span><span class="op">*</span><span class="va">REPS</span>,min<span class="op">=</span><span class="fl">0</span>,max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span>,<span class="va">np</span>,<span class="va">REPS</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  3 50</span></span>
<span></span>
<span></span>
<span><span class="va">stm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sr</span> <span class="op">&lt;-</span> <span class="fu">sim</span><span class="op">(</span><span class="va">P</span><span class="op">)</span></span>
<span><span class="va">etm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">etm</span>,<span class="va">stm</span><span class="op">)</span></span>
<span><span class="co">#&gt; Time difference of 0.2752998 secs</span></span></code></pre></div>
<p>Let’s plot all trajectories in one picture:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="cn">T</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t</span>,<span class="cn">NA</span><span class="op">)</span>,<span class="va">REPS</span><span class="op">)</span>                                  <span class="co"># the NA value will break the line</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">sr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,<span class="cn">NA</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>    <span class="co"># at the end, so it doesn't loop</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="cn">T</span>,<span class="va">Z</span>,type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="user_model_files/figure-html/Plots-1.png" width="700"></p>
<p>The new result is (just like the old one) an array with three
indexes:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sr</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="co"># a number</span></span></code></pre></div>
<ul>
<li>
<code>i</code> output function</li>
<li>
<code>j</code> time index</li>
<li>
<code>k</code> selects the trajectories that belong to
<code>P[,k]</code>
</li>
</ul>
<hr>
<p>Clean-up (delete temporary files):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"AKAR4cl%s"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".vf"</span>,<span class="st">".tar.gz"</span>,<span class="st">".zip"</span>,<span class="st">".so"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gf</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AKAR4cl.vf"     "AKAR4cl.tar.gz" "AKAR4cl.zip"    "AKAR4cl.so"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">gf</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-formats">Other Formats<a class="anchor" aria-label="anchor" href="#other-formats"></a>
</h2>
<p>The SBtab content can be a normal spreadsheet.</p>
<p>If it is a Google spreadsheet (which can be good for collaborative
work), you should write it until fairly satisfied with all components
and then export it as an <code>.xlsx</code>, or <code>.ods</code> file.
The gnumeric application can automatically convert both
<code>.xlsx</code> and <code>.ods</code> to a set of <code>.tsv</code>
files if you want the benefits of version control (which works on text
files). Both <code>.ods</code> and <code>.xlsx</code> work:</p>
<ul>
<li>
<code><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_ods.html" class="external-link">SBtabVFGEN::sbtab_from_ods</a></code> for ODS files</li>
<li>
<code><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_excel.html" class="external-link">SBtabVFGEN::sbtab_from_excel</a></code> for XLSX files</li>
</ul>
<p>Our scripts find the tables by name:</p>
<ul>
<li>TSV files: <code>TableName</code> attribute is the name of the
table</li>
<li>ODS files: the Sheet’s name is the name of the table,
<code>TableName</code> attribute is not parsed</li>
<li>Excel files: the Sheet’s name (same as ODS)</li>
</ul>
<div class="section level5">
<h5 id="tab-separated-values">Tab Separated Values<a class="anchor" aria-label="anchor" href="#tab-separated-values"></a>
</h5>
<p>For more information on how to solve common tasks regarding tsv
files, see the <a href="./tsv.html">tsv topic</a>. We obtain a list of
all tsv files in the current directory, and then import the contents,
like this:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span>pattern<span class="op">=</span><span class="st">'[.]tsv$'</span><span class="op">)</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="open-document-spreadsheet">Open Document Spreadsheet<a class="anchor" aria-label="anchor" href="#open-document-spreadsheet"></a>
</h5>
<p>These files can be created with Libre Office, Apple’s
<em>numbers</em> program, gnumeric, and any web-hosted spreadsheet
application (like Google spreadsheets).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="st">"DemoModel.ods"</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_ods.html" class="external-link">sbtab_from_ods</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="excel">Excel<a class="anchor" aria-label="anchor" href="#excel"></a>
</h5>
<p>These can be created with MS Excel, and loaded like this:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="st">"DemoModel.xlsx"</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_excel.html" class="external-link">sbtab_from_excel</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h2>
<p>The R code generated by <code>ode.sh</code> includes a list with the
same functions, but with generic function names:</p>
<ul>
<li>
<code>model$vf()</code> vector field</li>
<li>
<code>model$jac()</code> Jacobian</li>
<li>
<code>model$init()</code> initial values</li>
<li>
<code>model$par()</code> default parameters in linear scale
<ul>
<li>regardless of what the scale was in the SBtab file</li>
<li>this function returns the long parameter vector (Parameter and
Input)</li>
</ul>
</li>
</ul>
<p>Observe that <code>model$par()</code> returns the ODE model
parameters, which can be more than the biological parameters, the
components are:</p>
<ul>
<li>biological parameters (<code>SBtab$Parameter</code>)</li>
<li>original input parameters (<code>SBtab$Input</code>)</li>
<li>derived input parameters, from conservationlaws (conserved
constants)</li>
</ul>
<p>The inputs are allowed to be different for each experiment (by
definition), the biological parameters are the same for all experiments
simulated in one go. Therefore, we only supply the biological parameters
(the first <code>n</code>) to the simulator and it retrieves the others
from the <code>experiments</code> variable, by concatenation:</p>
<p>Usually, the number of leading parameters
(sb$Parameter[[“!DefaultValue”]]) does not change. This is all the
simulator needs as the inputs are already in <code>ex</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
