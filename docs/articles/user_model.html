<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uqsa">
<title>Using your own model • uqsa</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using your own model">
<meta property="og:description" content="uqsa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uqsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uqsa.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-installation">Installation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-installation">
    <a class="dropdown-item" href="../articles/install.html">Full Installation Instructions</a>
    <a class="dropdown-item" href="../articles/installation.html">Short Instructions</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-documentation">Documentation</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-documentation">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/uq.html">Uncertainty Quantification</a>
    <a class="dropdown-item" href="../articles/sa.html">Sensiticity Analysis</a>
    <h6 class="dropdown-header" data-toc-skip>Model and data management</h6>
    <a class="dropdown-item" href="../articles/SBtab.html">SBtab</a>
    <a class="dropdown-item" href="../articles/models.html">Importing a model</a>
    <a class="dropdown-item" href="../articles/data.html">Importing data</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Paremeter estimation and uncertainty quantification</h6>
    <a class="dropdown-item" href="../articles/simulate.html">Simulating a model</a>
    <a class="dropdown-item" href="../articles/ABC_sampling.html">ABC sampling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Sensitivity analysis</h6>
    <a class="dropdown-item" href="../articles/GSA.html">GSA following UQ</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/examples_overview.html">Overview</a>
    <a class="dropdown-item" href="../articles/AKAP79.html">AKAP79</a>
    <a class="dropdown-item" href="../articles/AKAR4.html">AKAR4</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="user_model_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using your own model</h1>
            
      
      
      <div class="d-none name"><code>user_model.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://icpm-kth.github.io/uqsa/">uqsa</a></span><span class="op">)</span></span></code></pre></div>
<p>In this article we will assume that you have a model that you want to work on and that you have written the model in SBtab form. It may be a google spreadsheet, and open document spreadsheet (<code>ods</code>), MS Excel file, a file for the <code>numbers</code> application on an Apple device or a <code>.gnumeric</code> file.</p>
<p>If it is a google spreadsheet (which can be good for collaborative work), you should write it until failry satisfied with all components and then export it as an <code>.xlsx</code>, or <code>.ods</code> file. The gnumeric application can automatically convert both <code>.xlsx</code> and <code>.ods</code> to a set of <code>.tsv</code> files if you want the benefits of version control (which works on text files). But, <code>.ods</code> and <code>.xlsx</code> both work with <code>SBtabVFGEN</code>.</p>
<p>In addition to how SBtab mdels are usually written, we require some mandatory components/tables (see SBtab topic). Our scripts find the tables by name convention, there is no manifest file. But the <em>Reaction</em> table can be seen as the main item of the model, while the <em>Experiments</em> table is the main file that relates experimental data to the model. All things mentioned in these two files need to be further explained in the other tables.</p>
<p>In summary: SBtab models contain a data portion, and a model portion; the SBtab tables also relate both to one another: the <em>Output</em> table describes what the model needs to calculate to allow direct comparison to the data (there are exceptions). The <em>Experiments</em> table specifies which inputs to apply, and initial conditions to set to replicate a data-set. It names each experiment, and the user must include a table/file that contains the data for each experiment, the file/table must be named like the identifier of the experiment (<em>leftmost column</em> stores the identifiers of each row).</p>
<p>We’ll assume that the model is called <code>DemoModel</code>, for all exaple lines.</p>
<p>Create a fresh directory for your model:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">mkdir</span> DemoModel</span></code></pre></div>
<p>Copy the SBtab file(s) there (in any of the formats above). Launch R in that directory (use <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code> to check whether you are in the directory, if unsure). It can be RStudio, but we’ll assume plain R here.</p>
<div class="section level2">
<h2 id="loading-the-model">Loading the Model<a class="anchor" aria-label="anchor" href="#loading-the-model"></a>
</h2>
<p>If the model is a collection of tsv files, you need to create an R list of the names; if it is just one file you only need to type out its name. In all cases, you need to load SBtabVFGEN.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span></code></pre></div>
<p>The instructions for <code>.ods</code> (readODS) and <code>.excel</code> (readxl) files will work as long as the packages we use to load them remain available. The <code>.tsv</code> format is the safest bet for reliability, because text files cannot object to being read very much (we read the <code>.tsv</code> files with <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">utils::read.delim</a></code>).</p>
<div class="section level3">
<h3 id="tab-separated-values">Tab Separated Values<a class="anchor" aria-label="anchor" href="#tab-separated-values"></a>
</h3>
<p>For more information on how to solve common tasks regarding tsv files, see the <a href="./tsv.html">tsv topic</a>. We obtain a list of all tsv files in the current directory, and then import the contents, like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span>pattern<span class="op">=</span><span class="st">'[.]tsv$'</span><span class="op">)</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_tsv.html" class="external-link">sbtab_from_tsv</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="open-document-spreadsheet">Open Document Spreadsheet<a class="anchor" aria-label="anchor" href="#open-document-spreadsheet"></a>
</h3>
<p>These files can be created with Libre Office, Apple’s <em>numbers</em> program, gnumeric, and any web-hosted spreadsheet application (like google spreadsheets).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="st">"DemoModel.ods"</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_ods.html" class="external-link">sbtab_from_ods</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="excel">Excel<a class="anchor" aria-label="anchor" href="#excel"></a>
</h3>
<p>These can be created with MS Excel, and loaded like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelFiles</span> <span class="op">&lt;-</span> <span class="st">"DemoModel.xlsx"</span></span>
<span><span class="va">SBtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_from_excel.html" class="external-link">sbtab_from_excel</a></span><span class="op">(</span><span class="va">modelFiles</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="converting-to-an-ordinary-differential-equation-model">Converting to an Ordinary Differential Equation Model<a class="anchor" aria-label="anchor" href="#converting-to-an-ordinary-differential-equation-model"></a>
</h2>
<p>In R, the SBtab content is now a named list of data frames (with the <code>!ID</code> column serving as <code>row.names</code>):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SBtab</span><span class="op">$</span><span class="va">Reaction</span></span></code></pre></div>
<p>This data frame corresponds to the sheet of the same name. The first column is always used to assign row names when creating the data frames. The next command produces a lot of output, with details how the script interprets the model. It will also do a conservation law analysis and automatically replace some of the state variables with algebraic assignments. The script picks the Compounds with the largest initial amount to be replaced. Normally, reacting compounds are represented by state variables, but the conserved quantities are interpreted as additional input parameters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conservationLaws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_to_vfgen.html" class="external-link">sbtab_to_vfgen</a></span><span class="op">(</span><span class="va">SBtab</span><span class="op">)</span></span></code></pre></div>
<p>which writes three main files:</p>
<ol style="list-style-type: decimal">
<li>DemoModel.vf - a vfgen vector field file (custom xml content).</li>
<li>DemoModel.mod - NEURON mod file, for simulations with the NEURON software.</li>
<li>DemoModel.xml - an SBML file for simulations in COPASI and others. This will only be done if the <code>sbml</code> package is available (the R package).</li>
</ol>
<p>The script also writes its findings in a fairly <em>format-free</em> way, as text files (they can be interpreted as an ODE without any target software in mind). <code><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab_to_vfgen.html" class="external-link">SBtabVFGEN::sbtab_to_vfgen()</a></code> also attempts to zip those <code>.txt</code> files.</p>
<div class="section level3">
<h3 id="automated-procedure">Automated Procedure<a class="anchor" aria-label="anchor" href="#automated-procedure"></a>
</h3>
<p>The github repository of <a href="https://www.github.com/icpm-kth/SBtabVFGEN" class="external-link">SBtabVFGEN</a> (systems biology table vector field generator) also includes an RScript called <code>sbtab_to_vfgen.sh</code>, it begins with:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/usr/bin/env Rscript</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SBtabVFGEN</span><span class="op">)</span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>So, it can be called directly from the command line, like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>$ <span class="ex">./sbtab_to_vfgen</span> *.tsv</span></code></pre></div>
<p>which will just create the <code>.vf</code>, <code>.xml</code>, and <code>.MOD</code> files, as well as <code>ConservationLaws.h5</code> (an hdf5 file) and an <code>.RData</code> file with the conservation laws.</p>
<p><em>NOTE</em>: If you wish to turn conservation law analysis off, change this script to include the option <code>cla=FALSE</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The data component of the SBtab is extracted using</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">experiments</span> <span class="op">&lt;-</span> <span class="fu">SBtabVFGEN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SBtabVFGEN/man/sbtab.data.html" class="external-link">sbtab.data</a></span><span class="op">(</span><span class="va">conservationLaws</span><span class="op">)</span></span>
<span><span class="va">experiments</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">input</span></span></code></pre></div>
<p>which returns a list with one element per entry in the <code>Experiments</code> table (<code>SBtab$Experiments</code> in R). Each list item contains the data set (as two data frames, the second for measurement error estimates), but also inputs for the model that are meant to fit the data, and initial values for all state variables. These simulation instructions always accompany the data, and can include scheduled events (sudden changes in the system).</p>
</div>
<div class="section level2">
<h2 id="the-ode-must-be-converted-to-code">The ODE must be converted to code<a class="anchor" aria-label="anchor" href="#the-ode-must-be-converted-to-code"></a>
</h2>
<p>The <code>vf</code> file, or SBML, or even the text output we created are not yet code that can be simulated. An ODE solver needs a right-hand-side function, in the programming language the solver runs in.</p>
<p>In some software, this code generation happens invisibly in the background, or the model is kept in the high level language (which makes simulations slow).</p>
<p>We prefer to be able to see the generated code, to check for errors, or to change the code by hand (if necessary).</p>
<p>The ODE model source-code can also be written by hand in th efirst place. In that case none of the above is needed; so, we could have started here. But this is <em>difficult</em> and gets more difficult for <em>bigger models</em>.</p>
<p>Fast, advanced (more accurate) solvers require additional functions, at least the jacobian of the ODE system:</p>
<p><span class="math display">\[ J(t,x;p)_{ij} = \frac{d f_i(t,x;p)}{dx_j}\,,\]</span></p>
<p>where <span class="math inline">\(p\)</span> are the parameters of the ODE model.</p>
<p>We generate this code automatically using our own package: <a href="https://www.github.com/icpm-kth/RPN-derivative" class="external-link">RPN-derivative</a>.</p>
<p>It is not an R package (it’s partially written in C), but can be run on the command line in a POSIX compliant shell (<code>zsh</code>,<code>bash</code>,<code>dash</code>, etc.). It uses both <code>sed</code> and <code>awk</code> as well, which are always present on a unix derived system (but annoyingly, with different capabilities).</p>
<p>The package repository contains a shell script called <code>ode.sh</code>, which can use one of three backends for derivative calculations: internal, maxima, or yacas. It is just a file, not installed anywhere, the package contains some helper programs (to calculate derivatives), which can be installed (<code>make &amp;&amp; make install</code>). But you can entirely omit the <code>make</code> step if you plan on using the maxima or yacas backend. It is probably good to alias the ode shell script: <code>alias ode='$HOME/RPN-derivative/sh/ode.sh'</code> (or wherever you put that file).</p>
<p>Or, alternatively, put it somewhere that is in your <code>$PATH</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ex">ode</span> --maxima -C DemoModel.vf <span class="op">&gt;</span> DemoModel_gvf.c</span></code></pre></div>
<p>Or, more generically:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="ex">ode</span> [--yacas<span class="kw">|</span><span class="ex">--maxima</span>] -R DemoModel.<span class="dt">{zip,vf,tar.gz}</span> <span class="op">&gt;</span> DemoModel.R</span></code></pre></div>
<p>These files only need to be re-created if you change the model structurally. A change in initial conditions, or parameter values will result in largely the same code, except for the function that returns the default initial conditions and default parameter values.</p>
<p>The R code is usually not used for simulations (not by us), but can be useful to call any of the model functions within R (e.g. after simulation), to build sampling algorithms, or to make a user-supplied objective function that internally uses the deSolve package for simulations. The functions in <code>DemoModel.R</code> are compatible with <code>deSolve</code>.</p>
<p>Once you have <code>DemoModel_gvf.c</code> you can either convert it to a shared library yourself, or use the <code>checkModel</code> function included in <code>uqsa</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="fu">gcc</span> -shared -fPIC -O2 -o DemoModel.so DemoModel_gvf.c</span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu">uqsa</span><span class="fu">::</span><span class="fu"><a href="../reference/checkModel.html">checkModel</a></span><span class="op">(</span><span class="st">"DemoModel"</span>, <span class="st">"./DemoModel_gvf.c"</span><span class="op">)</span></span>
<span>                             <span class="co"># model-name,      file-name</span></span>
<span><span class="co">## comment(modelName) == "DemoModel.so"</span></span></code></pre></div>
<p>This shared object file can be used for simulations.</p>
</div>
<div class="section level2">
<h2 id="simulations">Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h2>
<p>The previously created <code>modelName</code> variable has a comment attribute (that you can also set yourself, there is no magic there). This comment indicates the shared object file to simulate with. In R, using <code>uqsa</code> we first create a closure:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulator.c.html">simulator.c</a></span><span class="op">(</span><span class="va">experiments</span>, <span class="va">modelName</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">sim</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p>now, <code>sim</code> is a function that implicitly depends on the simulation instructions in the list of <code>experiments</code>, and explicitly on the supplied parameters <code>p</code> (a numeric vector, or matrix). The return value <code>y</code> is also a list with one result per experiment: <code>length(y)==length(experiments)</code>.</p>
<p>The result contains two components per list item: the state variables, and the output values</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="co"># a number</span></span></code></pre></div>
<p>which corresponds to experiment <code>l</code>, output function <code>i</code>, time-point <code>j</code>, and parameter column <code>k</code> (if <code>p</code> was a matrix). When <code>p</code> is a vector, then <code>k</code> can only be <code>1</code>. Similarly, for state variables:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">state</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="co"># a number</span></span></code></pre></div>
<p>corresponds to experiment <code>l</code>, state variable <code>i</code>, time-point <code>j</code>, and parameter column <code>k</code> (again, relevant when <code>p</code> is a matrix).</p>
<p>The results can be visualized by plotting against the experiment’s output time values:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot output function 1, for experiment 2</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">par</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">sim</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">experiments</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outputTimes</span>, <span class="va">y</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">func</span><span class="op">[</span><span class="fl">1</span>,,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>(in this case <code>p</code> is a vector).</p>
<div class="section level4">
<h4 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h4>
<p>Observe that model$par() returns the ODE model parameters, which can be more than the biological parameters, the components are:</p>
<ul>
<li>biological parameters (<code>SBtab$Parameter</code>)</li>
<li>origignal input parameters (<code>SBtab$Input</code>)</li>
<li>derived input parameter, from conservationlaws (conserved constants)</li>
</ul>
<p>The inputs are allowed to be different for each experiment (by definition), the biological parameters are the same for all experiments simulated in one go. Therefore, we only supply the biological parameters (the first <code>n</code>) to the simultor and it retrieves the others from the <code>experiments</code> variable, by concatenation:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">p</span>,<span class="va">experiments</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">input</span><span class="op">)</span> <span class="co"># for each l</span></span></code></pre></div>
<p>for experiment <code>l</code>, or <code>c(parMap(p),experiments[[l]]$input)</code>, if <code>parMap</code> is non-trivial.</p>
</div>
<div class="section level3">
<h3 id="benefits-of-intermediates">Benefits of Intermediates<a class="anchor" aria-label="anchor" href="#benefits-of-intermediates"></a>
</h3>
<p>Every step above produces an output file that carries a meaning:</p>
<ul>
<li>the SBtab spreadsheet describes the biological model (so does SBML)
<ul>
<li>but with some consideration regarding systems (input/output model)</li>
</ul>
</li>
<li>the <code>.vf</code> file represents the model as an ODE</li>
<li>the <code>.c</code> file is the code representation of the ODE model, intended for a specific solver suite.</li>
</ul>
<p>Each of these files can be checked by the user, their internal formats are not hidden; this can help with checking for errors and testing, resability, and interoperability between different software packages.</p>
<p>The vfgen software can also create model files for both R and C, but the functions are slightly different from ours. We decided to write our own converter for several reasons:</p>
<ul>
<li>vfgen creates one function per output, with the output name in the function name, e.g.: <code>int DemoModel_ABCoverSUM(...)</code>
<ul>
<li>our script creates one output function that returns a vector (one item per output line in SBtab) – vector valued output</li>
</ul>
</li>
<li>vfgen does not write a <em>default initial conditions</em> or <em>default parameter</em> function
<ul>
<li>these should be functions, because they can depend on the constants in the model, on previous parameters, and even on the initial time t₀, e.g.: <code>double par12 = t&gt;0 ? par3*par5 : par5;</code>
</li>
</ul>
</li>
<li>the vfgen functions do not return an error code for <code>NULL</code> in-out-buffers (which is fine)
<ul>
<li>we use these error codes to probe the dimensionality of the model, without writing extra data structures</li>
</ul>
</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexandra Jauhiainen, Olivia Eriksson, Federica Milinanni, Andrei Kramer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
